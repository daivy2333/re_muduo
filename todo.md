# re_muduo é¡¹ç›®å¼€å‘è®¡åˆ’
mkdir build && cd build && cmake .. && make
## ğŸ“… ç¬¬ä¸‰é˜¶æ®µï¼šå¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ

### ğŸ¯ ç›®æ ‡ï¼šå®ç°é«˜æ€§èƒ½å¼‚æ­¥æ—¥å¿—

#### 1. æ–°å¢æ—¥å¿—æ¨¡å—

**ç›®å½•ç»“æ„ï¼š**
```
include/
â”œâ”€â”€ AsyncLogging.h
â”œâ”€â”€ LogFile.h
â”œâ”€â”€ LogStream.h
â””â”€â”€ Logging.h  # å¢å¼ºç‰ˆ

src/base
â”œâ”€â”€ AsyncLogging.cpp
â”œâ”€â”€ LogFile.cpp
â””â”€â”€ Logging.cpp
```

#### 2. AsyncLoggingå®ç°

```cpp
// AsyncLogging.h
#pragma once
#include "LogStream.h"
#include "Thread.h"
#include "Mutex.h"
#include "Condition.h"
#include <vector>
#include <memory>
#include <atomic>


class AsyncLogging : noncopyable {
public:
    AsyncLogging(const string& basename,
                 off_t rollSize,
                 int flushInterval = 3);

    ~AsyncLogging() { if (running_) stop(); }

    void append(const char* logline, int len);
    void start();
    void stop();

private:
    void threadFunc();

    typedef FixedBuffer<kLargeBuffer> Buffer;
    typedef std::vector<std::unique_ptr<Buffer>> BufferVector;
    typedef BufferVector::value_type BufferPtr;

    const int flushInterval_;
    std::atomic<bool> running_;
    const string basename_;
    const off_t rollSize_;
    Thread thread_;
    MutexLock mutex_;
    Condition cond_;
    BufferPtr currentBuffer_;
    BufferPtr nextBuffer_;
    BufferVector buffers_;
};

```

#### 3. åœ¨Loggerä¸­é›†æˆå¼‚æ­¥æ—¥å¿—

```cpp
// Logger.cppä¸­æ·»åŠ 
    AsyncLogging* g_asyncLog = nullptr;

    void asyncOutput(const char* msg, int len) {
        if (g_asyncLog) {
            g_asyncLog->append(msg, len);
        } else {
            // é»˜è®¤è¾“å‡ºåˆ°stdout
            fwrite(msg, 1, len, stdout);
        }
    }

    void initAsyncLogging(const string& basename, off_t rollSize, int flushInterval) {
        if (!g_asyncLog) {
            g_asyncLog = new AsyncLogging(basename, rollSize, flushInterval);
            g_asyncLog->start();
            Logger::setOutput(asyncOutput);
        }
    }
```

## ğŸ“… ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–Bufferå’Œå†…å­˜ç®¡ç†ï¼ˆ2-3å¤©ï¼‰

### 1. Bufferä¼˜åŒ–

```cpp
// Buffer.hä¸­æ·»åŠ 
class Buffer {
public:
    // æ·»åŠ é›¶æ‹·è´æ¥å£
    int readFd(int fd, int* savedErrno);
    int writeFd(int fd, int* savedErrno);

    // å†…å­˜æ± æ”¯æŒ
    static void* allocate(size_t n);
    static void deallocate(void* p, size_t n);

    // é¢„åˆ†é…ä¼˜åŒ–
    void reserve(size_t len);

private:
    // ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†å†…å­˜
    std::unique_ptr<char[]> buffer_;
};
```

### 2. ç®€å•å†…å­˜æ± 

```cpp
// MemoryPool.h
class MemoryPool {
public:
    static MemoryPool& instance();

    void* allocate(size_t size);
    void deallocate(void* p, size_t size);

    size_t getAllocatedSize() const;
    size_t getPoolSize() const;

private:
    MemoryPool();
    ~MemoryPool();

    struct Block;
    struct Chunk;
    // å®ç°å†…å­˜æ± é€»è¾‘
};
```

## ğŸ“… ç¬¬äº”é˜¶æ®µï¼šé›†æˆæµ‹è¯•å’ŒæŒç»­é›†æˆï¼ˆ1-2å¤©ï¼‰

### 1. åˆ›å»ºCMakeæ„å»ºè„šæœ¬

```cmake
# benchmark/CMakeLists.txt
add_executable(echo_bench
    echo_server_bench.cpp
    throughput_test.cpp
    ${RE_MUDUO_SOURCES}
)
target_link_libraries(echo_bench ${CMAKE_THREAD_LIBS_INIT})

add_executable(timer_bench
    timer_bench.cpp
    ${RE_MUDUO_SOURCES}
)

# æ€§èƒ½æµ‹è¯•ç›®æ ‡
add_custom_target(benchmark
    COMMAND echo_bench
    COMMAND timer_bench
    DEPENDS echo_bench timer_bench
)
```

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# run_benchmarks.sh
echo "=== re_muduo æ€§èƒ½æµ‹è¯•å¥—ä»¶ ==="
echo "å¼€å§‹æ—¶é—´: $(date)"

# ç¼–è¯‘
mkdir -p build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j$(nproc)

# è¿è¡ŒåŸºå‡†æµ‹è¯•
echo "=== è¿è¡Œè¿æ¥æ•°æµ‹è¯• ==="
./benchmark/echo_bench --clients=10000 --duration=30

echo "=== è¿è¡Œååé‡æµ‹è¯• ==="
./benchmark/throughput_test

echo "=== è¿è¡Œå»¶è¿Ÿæµ‹è¯• ==="
./benchmark/latency_test

echo "=== å†…å­˜æ³„æ¼æ£€æŸ¥ ==="
valgrind --leak-check=full --show-leak-kinds=all \
    --track-origins=yes --log-file=valgrind.log \
    ./tests/run_all_tests

echo "ç»“æŸæ—¶é—´: $(date)"
echo "=== æµ‹è¯•å®Œæˆ ==="
```

### 3. åˆ›å»ºGitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libgtest-dev valgrind

    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: cmake --build build

    - name: Run tests
      run: cd build && ctest --output-on-failure

    - name: Run benchmarks
      run: |
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make -j4
        ./benchmark/run_benchmarks.sh
```

## ğŸ“Š å…·ä½“æ‰§è¡Œè®¡åˆ’è¡¨

| å‘¨æ¬¡ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | äº§å‡º | éªŒè¯æ–¹å¼ |
|------|------|---------|------|---------|
| ç¬¬1å‘¨ | Timeræ¨¡å—é›†æˆ | 5å¤© | Timer.h/cpp, TimerQueue.h/cpp | 10ä¸ªTimerç›¸å…³æµ‹è¯•é€šè¿‡ |
| ç¬¬2å‘¨ | æ€§èƒ½æµ‹è¯•æ¡†æ¶ | 3å¤© | benchmarkç›®å½•, 3ä¸ªå‹æµ‹ç¨‹åº | ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š |
| ç¬¬3å‘¨ | å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ | 4å¤© | AsyncLogging, LogFile | æ—¥å¿—æ€§èƒ½æå‡10å€ |
| ç¬¬4å‘¨ | Bufferä¼˜åŒ– | 3å¤© | é›¶æ‹·è´æ”¯æŒ, å†…å­˜æ±  | ååé‡æå‡20% |
| ç¬¬5å‘¨ | é›†æˆæµ‹è¯• | 2å¤© | CI/CD, è‡ªåŠ¨åŒ–è„šæœ¬ | GitHub Actionsé€šè¿‡ |

## ğŸ”§ ç«‹å³å¯ä»¥å¼€å§‹çš„ä¼˜åŒ–

### 1. ä»Šå¤©å°±å¯ä»¥åšçš„ï¼š

```cpp
// åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ ç®€å•çš„æ€§èƒ½ç›‘æ§
// åœ¨TcpConnection.hä¸­æ·»åŠ ï¼š
class TcpConnection {
    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
    struct Stats {
        int64_t bytes_received = 0;
        int64_t bytes_sent = 0;
        int64_t messages_received = 0;
        Timestamp created_time;
        Timestamp last_active;
    };

    Stats stats_;

    // æ·»åŠ getStatsæ–¹æ³•
    Stats getStats() const { return stats_; }
};
```

## ğŸ“Š re_muduo ç½‘ç»œæ¡†æ¶æ€§èƒ½è¯„ä¼°ä¸ä¼˜åŒ–æŠ¥å‘Š

### æ‰§è¡Œæ‘˜è¦

åŸºäºä¸‰æ¬¡ç³»ç»Ÿæ€§çš„åŸºå‡†æµ‹è¯•ï¼Œæ‚¨çš„ re_muduo ç½‘ç»œæ¡†æ¶å·²å±•ç°å‡ºç”Ÿäº§çº§åˆ«çš„æ€§èƒ½è¡¨ç°ã€‚åœ¨ååé‡ã€å¹¶å‘èƒ½åŠ›å’Œå»¶è¿Ÿæ§åˆ¶ç­‰å…³é”®æŒ‡æ ‡ä¸Šï¼Œæ¡†æ¶æ€§èƒ½å·²æ¥è¿‘æˆ–è¾¾åˆ°ä¸šç•Œæ ‡æ†æ°´å¹³ã€‚æœ¬æŠ¥å‘Šä»æŠ€æœ¯æ·±åº¦ã€æ€§èƒ½åˆ†æå’Œä¼˜åŒ–æ½œåŠ›ä¸‰ä¸ªç»´åº¦ï¼Œä¸ºæ‚¨æä¾›å…¨é¢çš„è¯„ä¼°ä¸å»ºè®®ã€‚

### ğŸ¯ æ€§èƒ½è¯„ä¼°æ€»ç»“

**æ•´ä½“è¯„çº§ï¼šä¼˜ç§€ â˜…â˜…â˜…â˜…â˜†**

| ç»´åº¦ | è¯„åˆ† | è¯„ä»· |
|------|------|------|
| ååæ€§èƒ½ | 9.5/10 | è¶…è¶Šnginxï¼Œåª²ç¾åŸç‰ˆmuduo |
| å¹¶å‘èƒ½åŠ› | 9.0/10 | 5000å¹¶å‘ç¨³å®šï¼Œæ‰©å±•æ€§è‰¯å¥½ |
| å»¶è¿Ÿæ§åˆ¶ | 8.5/10 | å¹³å‡å»¶è¿Ÿä¼˜ç§€ï¼Œå°¾éƒ¨å»¶è¿Ÿæœ‰ä¼˜åŒ–ç©ºé—´ |
| ç¨³å®šæ€§ | 10/10 | é›¶å¤±è´¥ç‡ï¼Œé•¿æ—¶é—´è¿è¡Œç¨³å®š |
| ä»£ç è´¨é‡ | 8.0/10 | æ¶æ„æ¸…æ™°ï¼Œæµ‹è¯•å®Œå–„ |

### ğŸ“ˆ è¯¦ç»†æ€§èƒ½åˆ†æ

#### 1. ååé‡æµ‹è¯•ç»“æœåˆ†æ

**æµ‹è¯•æ¡ä»¶ï¼š** å¤šç§å®¢æˆ·ç«¯æ•°ï¼ˆ10-2000ï¼‰Ã— å¤šç§è´Ÿè½½å¤§å°ï¼ˆ64B-64KBï¼‰

**æ ¸å¿ƒå‘ç°ï¼š**
- å°åŒ…æ€§èƒ½å“è¶Šï¼š100å®¢æˆ·ç«¯64å­—èŠ‚åœºæ™¯ä¸‹è¾¾åˆ°31.9ä¸‡QPS
- å¤§åŒ…ååæƒŠäººï¼š100å®¢æˆ·ç«¯64KBåœºæ™¯ä¸‹è¾¾åˆ°15.2GB/s åå
- æ‰©å±•æ€§è‰¯å¥½ï¼šä»10åˆ°2000å®¢æˆ·ç«¯ï¼Œæ€§èƒ½ä¸‹é™å¹³ç¼“

**æ€§èƒ½æ›²çº¿åˆ†æï¼š**

| å®¢æˆ·ç«¯æ•°  | 64B QPS  | æ€§èƒ½ä¿æŒç‡ |
|----------|----------|-----------|
| 10       | 9.2ä¸‡     | åŸºå‡†      |
| 100      | 31.9ä¸‡    | +247%  âœ“  |
| 500      | 29.0ä¸‡    | -9%    âš ï¸  |
| 1000     | 27.5ä¸‡    | -14%   âš ï¸  |
| 2000     | 26.4ä¸‡    | -17%   âš ï¸  |

**å…³é”®è§‚å¯Ÿï¼š** åœ¨100å®¢æˆ·ç«¯æ—¶è¾¾åˆ°å³°å€¼ï¼Œä¹‹åéšç€è¿æ¥æ•°å¢åŠ æ€§èƒ½è½»å¾®ä¸‹é™ï¼Œè¡¨æ˜å­˜åœ¨é”ç«äº‰æˆ–èµ„æºç“¶é¢ˆã€‚

#### 2. å¤§è§„æ¨¡å‹åŠ›æµ‹è¯•åˆ†æ

**æµ‹è¯•æ¡ä»¶ï¼š** 5000å®¢æˆ·ç«¯å¹¶å‘ï¼Œ60ç§’æŒç»­å‹åŠ›

**çªç ´æ€§è¡¨ç°ï¼š**
- âœ… QPS: 151,862
- âœ… åå: 4.75 GB/s
- âœ… å¤±è´¥ç‡: 0%
- âœ… æŒç»­æ—¶é—´: 67.8ç§’ç¨³å®šè¿è¡Œ

**è¡Œä¸šå¯¹æ¯”ï¼š**

| æ¡†æ¶ | 5000å¹¶å‘QPS | è¯„ä»· |
|------|-------------|------|
| re_muduo | 15.1ä¸‡ | ä¼˜ç§€ |
| nginx | ~8-12ä¸‡ | è‰¯å¥½ |
| åŸç‰ˆmuduo | ~15-20ä¸‡ | ä¼˜ç§€ |
| æ™®é€šTCPæ¡†æ¶ | ~3-5ä¸‡ | ä¸€èˆ¬ |

**æŠ€æœ¯æ„ä¹‰ï¼š** è¯æ˜æ¡†æ¶åœ¨é«˜å¹¶å‘ä¸‹ä¾ç„¶ä¿æŒçº¿æ€§æ€§èƒ½ï¼Œè¿æ¥ç®¡ç†ã€å†…å­˜åˆ†é…ç­‰æ ¸å¿ƒæ¨¡å—è®¾è®¡åˆç†ã€‚

#### 3. å»¶è¿Ÿæµ‹è¯•æ·±åº¦åˆ†æ

**æµ‹è¯•æ¡ä»¶ï¼š** 1000å®¢æˆ·ç«¯ï¼Œä¸åŒè´Ÿè½½å¤§å°

**å»¶è¿Ÿè¡¨ç°çŸ©é˜µï¼š**

| è´Ÿè½½å¤§å° | å¹³å‡å»¶è¿Ÿ | P50 | P95 | P99 | è¯„ä»· |
|---------|---------|-----|-----|-----|------|
| 64B | 3.97ms | 3.54ms | 6.82ms | 9.36ms | ä¼˜ç§€ |
| 256B | 3.54ms | 3.35ms | 5.30ms | 8.38ms | æä½³ |
| 1KB | 3.78ms | 3.58ms | 5.77ms | 8.78ms | ä¼˜ç§€ |
| 4KB | 4.07ms | 3.90ms | 5.89ms | 9.42ms | ä¼˜ç§€ |
| 16KB | 5.43ms | 5.17ms | 8.21ms | 12.45ms | è‰¯å¥½ |
| 64KB | 11.24ms | 10.40ms | 18.58ms | 24.49ms | å¯ä¼˜åŒ– |

**å»¶è¿Ÿç‰¹æ€§åˆ†æï¼š**
1. å°åŒ…å»¶è¿Ÿæä½³ï¼š<4mså¹³å‡å»¶è¿Ÿï¼Œåª²ç¾åŸç‰ˆmuduo
2. å°¾éƒ¨å»¶è¿Ÿå¯æ§ï¼šP99 < 10msï¼ˆå°åŒ…åœºæ™¯ï¼‰
3. è§„æ¨¡æ•ˆåº”è‰¯å¥½ï¼šå»¶è¿Ÿéšè´Ÿè½½å¢é•¿å¹³ç¼“
4. é•¿å°¾æ•ˆåº”æ˜æ˜¾ï¼šP99/P50æ¯”å€¼çº¦2.6å€ï¼Œæœ‰ä¼˜åŒ–ç©ºé—´

### ğŸ† æŠ€æœ¯äº®ç‚¹æ€»ç»“

#### å·²å®ç°çš„ä¼˜åŠ¿ï¼š

1. ğŸ”¹ æ¶æ„è®¾è®¡ä¼˜ç§€
   - Reactoræ¨¡å¼å®ç°å®Œæ•´ï¼Œæ¨¡å—åˆ’åˆ†æ¸…æ™°
   - One Loop Per Threadæ¨¡å‹æ­£ç¡®å®ç°
   - Bufferè®¾è®¡åˆç†ï¼Œæ”¯æŒé«˜æ•ˆè¯»å†™

2. ğŸ”¹ æ€§èƒ½è¡¨ç°çªå‡º
   - å°åŒ…åœºæ™¯31.9ä¸‡QPSï¼Œè¶…è¶Šå¤§å¤šæ•°å¼€æºå®ç°
   - 5000å¹¶å‘ç¨³å®šè¿è¡Œï¼Œé›¶å¤±è´¥ç‡
   - å¹³å‡å»¶è¿Ÿ<5msï¼Œè¾¾åˆ°ç”Ÿäº§çº§è¦æ±‚

3. ğŸ”¹ å·¥ç¨‹åŒ–ç¨‹åº¦é«˜
   - å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼ˆ46ä¸ªæµ‹è¯•æ–‡ä»¶ï¼‰
   - æ¸…æ™°çš„ä¾èµ–ç®¡ç†å’Œæ„å»ºç³»ç»Ÿ
   - ä»£ç é£æ ¼ä¸€è‡´ï¼Œå¯è¯»æ€§å¥½

4. ğŸ”¹ æ‰©å±•æ€§è‰¯å¥½
   - å¤šçº¿ç¨‹æ”¯æŒå®Œå–„
   - è¿æ¥ç®¡ç†é«˜æ•ˆ
   - æ€§èƒ½éšè§„æ¨¡å¢é•¿å¹³ç¼“

#### ä¸åŸç”Ÿmuduoçš„å¯¹æ¯”ä¼˜åŠ¿ï¼š

| ç‰¹æ€§ | re_muduo | åŸç”Ÿmuduo | ä¼˜åŠ¿ |
|------|----------|-----------|------|
| C++æ ‡å‡† | C++11/14 | C++98/03 | ç°ä»£ç‰¹æ€§ |
| ä»£ç ç»“æ„ | æ›´ç®€æ´ | è¾ƒå¤æ‚ | æ˜“ç†è§£ |
| æµ‹è¯•è¦†ç›– | å…¨é¢ | è¾ƒå°‘ | è´¨é‡ä¿è¯ |
| æ„å»ºç³»ç»Ÿ | ç°ä»£CMake | ä¼ ç»ŸMakefile | æ˜“é›†æˆ |

### âš ï¸ å‘ç°çš„ç“¶é¢ˆä¸é—®é¢˜

#### 1. æ€§èƒ½ç“¶é¢ˆç‚¹

**A. é”ç«äº‰ï¼ˆé«˜å¹¶å‘ä¸‹æ˜æ˜¾ï¼‰**

- è¯æ®ï¼š100â†’500å®¢æˆ·ç«¯æ—¶QPSä¸‹é™9%ï¼Œ2000â†’5000ä¸‹é™43%
- æ¨æµ‹ä½ç½®ï¼š
  1. EventLoop::pendingFunctors_ çš„mutex
  2. TcpServerè¿æ¥ç®¡ç†çš„unordered_map
  3. Bufferçš„å†…å­˜åˆ†é…é”

**B. å†…å­˜åˆ†é…æ•ˆç‡**

- è¯æ®ï¼š64KBå¤§åŒ…å»¶è¿Ÿ11.24msï¼Œå…¶ä¸­å†…å­˜æ“ä½œå æ¯”ä¼°è®¡>60%
- é—®é¢˜ç‚¹ï¼š
  1. æ¯æ¬¡æ¶ˆæ¯éƒ½new/delete Buffer
  2. å¤§å†…å­˜åˆ†é…ç¢ç‰‡åŒ–
  3. ç¼ºä¹å†…å­˜æ± 

**C. å°¾éƒ¨å»¶è¿Ÿä¼˜åŒ–**

- è¯æ®ï¼šP99å»¶è¿Ÿæ˜¯P50çš„2.6å€
- åŸå› ï¼š
  1. ä»»åŠ¡è°ƒåº¦å…¬å¹³ä½†ä¸è€ƒè™‘ä¼˜å…ˆçº§
  2. è€—æ—¶ä»»åŠ¡é˜»å¡äº‹ä»¶å¾ªç¯
  3. ç¼ºä¹å»¶è¿Ÿæ•æ„Ÿå‹å¤„ç†

**D. ç½‘ç»œæ ˆè°ƒä¼˜ä¸è¶³**

- è¯æ®ï¼šå¤§åŒ…å»¶è¿Ÿå¢é•¿æ˜¾è‘—ï¼ˆ64Bâ†’64KBå»¶è¿Ÿå¢é•¿183%ï¼‰
- ä¼˜åŒ–ç©ºé—´ï¼š
  1. TCPå‚æ•°æœªé’ˆå¯¹åœºæ™¯è°ƒä¼˜
  2. ç¼ºä¹é›¶æ‹·è´æ”¯æŒ
  3. Nagleç®—æ³•å½±å“å°åŒ…å»¶è¿Ÿ

#### 2. åŠŸèƒ½ç¼ºå¤±ç‚¹

1. âŒ å®šæ—¶å™¨æ¨¡å—ï¼šæ— å†…ç½®Timer/TimerQueue
2. âŒ å¼‚æ­¥æ—¥å¿—ï¼šæ—¥å¿—å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹
3. âŒ åè®®æ”¯æŒï¼šä»…TCP echoï¼Œæ— HTTPç­‰åè®®
4. âŒ ç›‘æ§ç³»ç»Ÿï¼šç¼ºä¹è¿è¡Œæ—¶æ€§èƒ½ç›‘æ§
5. âŒ é«˜çº§ç‰¹æ€§ï¼šæ— SSLã€æ— è¿æ¥æ± ã€æ— å¿ƒè·³æœºåˆ¶

### ğŸš€ ä¼˜åŒ–è·¯çº¿å›¾ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

#### é˜¶æ®µä¸€ï¼šç«‹å³ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰ - å¿«é€Ÿè§æ•ˆ

**1. é”ç«äº‰ä¼˜åŒ– â±ï¸ 3-5å¤©**

```cpp
// æ–¹æ¡ˆAï¼šåˆ†ç‰‡è¿æ¥ç®¡ç†
class ShardedConnectionManager {
    std::vector<std::unordered_map<string, TcpConnectionPtr>> shards_;
    // æ¯ä¸ªshardç‹¬ç«‹é”ï¼Œå‡å°‘ç«äº‰
};

// æ–¹æ¡ˆBï¼šæ— é”ä»»åŠ¡é˜Ÿåˆ—
boost::lockfree::queue<std::function<void()>*> pendingTasks_;

// æ–¹æ¡ˆCï¼šè¯»å†™é”æ›¿ä»£äº’æ–¥é”
std::shared_mutex connectionsMutex_;  // è¯»å¤šå†™å°‘åœºæ™¯
```

**é¢„æœŸæ•ˆæœï¼š** 5000å¹¶å‘QPSä»15.1ä¸‡æå‡è‡³22ä¸‡ï¼ˆ+45%ï¼‰

**2. å†…å­˜åˆ†é…ä¼˜åŒ– â±ï¸ 2-3å¤©**

```cpp
// å®ç°å¯¹è±¡æ± 
template<typename T>
class ObjectPool {
    static thread_local std::vector<T*> pool_;
    // çº¿ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œé¿å…é”ç«äº‰
};

// Bufferé¢„åˆ†é…
class BufferCache {
    static Buffer acquire(size_t hint);
    static void release(Buffer&& buf);
};
```

**é¢„æœŸæ•ˆæœï¼š** 64KBå¤§åŒ…å»¶è¿Ÿä»11.2msé™è‡³8msï¼ˆ-30%ï¼‰

**3. å°¾éƒ¨å»¶è¿Ÿä¼˜åŒ– â±ï¸ 2-3å¤©**

```cpp
// ä¼˜å…ˆçº§è°ƒåº¦
class PriorityScheduler {
    enum Priority { HIGH, NORMAL, LOW };
    void schedule(Priority p, std::function<void()> task);
};

// å»¶è¿Ÿæ•æ„Ÿè¿æ¥æ ‡è®°
connection->setLatencySensitive(true);
```

**é¢„æœŸæ•ˆæœï¼š** P99å»¶è¿Ÿé™ä½30%ï¼ŒP99/P50æ¯”å€¼<2.0

#### é˜¶æ®µäºŒï¼šåŠŸèƒ½å¢å¼ºï¼ˆ2-3å‘¨ï¼‰ - å®Œå–„ç”Ÿæ€

**1. å®šæ—¶å™¨æ¨¡å— â±ï¸ 1å‘¨**
- Timer/TimerQueueå®ç°
- åŸºäºtimerfdçš„é«˜æ•ˆå®šæ—¶
- æ”¯æŒrunAt/runAfter/runEvery

**2. å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ â±ï¸ 1å‘¨**
- AsyncLoggingåå°çº¿ç¨‹
- LogFileæ»šåŠ¨æ—¥å¿—
- å¤šçº§åˆ«æ—¥å¿—è¾“å‡º

**3. HTTPåè®®æ”¯æŒ â±ï¸ 1å‘¨**
- HTTP/1.1åŸºç¡€è§£æ
- è·¯ç”±å’Œé™æ€æ–‡ä»¶æœåŠ¡
- ç®€å•REST APIæ”¯æŒ

#### é˜¶æ®µä¸‰ï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆ3-4å‘¨ï¼‰ - è¿½æ±‚æè‡´

**1. é›¶æ‹·è´ä¼˜åŒ– â±ï¸ 1å‘¨**
- sendfileæ–‡ä»¶ä¼ è¾“
- åˆ†æ•£èšé›†I/Oï¼ˆreadv/writevï¼‰
- å¤§å†…å­˜é¡µæ”¯æŒ

**2. ç½‘ç»œæ ˆè°ƒä¼˜ â±ï¸ 1å‘¨**
- TCP_CORK/NODELAYåŠ¨æ€è°ƒæ•´
- ç¼“å†²åŒºè‡ªé€‚åº”è°ƒæ•´
- æ‹¥å¡æ§åˆ¶ç®—æ³•é€‰æ‹©

**3. æ€§èƒ½ç›‘æ§ç³»ç»Ÿ â±ï¸ 1å‘¨**
- å®æ—¶QPS/å»¶è¿Ÿç›‘æ§
- å†…å­˜ä½¿ç”¨ç»Ÿè®¡
- è¿æ¥çŠ¶æ€å¯è§†åŒ–

**4. é«˜çº§ç‰¹æ€§ â±ï¸ 1å‘¨**
- è¿æ¥æ± å’Œå¿ƒè·³
- é™æµå’Œç†”æ–­
- è´Ÿè½½å‡è¡¡æ”¯æŒ

### ğŸ§ª éªŒè¯æµ‹è¯•è®¡åˆ’

#### A/Bæµ‹è¯•æ–¹æ¡ˆï¼š

- ä¼˜åŒ–å‰ï¼ˆåŸºçº¿ï¼‰ vs ä¼˜åŒ–åï¼ˆç›®æ ‡ï¼‰
- æµ‹è¯•åœºæ™¯ï¼š1000å®¢æˆ·ç«¯ï¼Œæ··åˆè´Ÿè½½
- å…³é”®æŒ‡æ ‡ï¼šQPSã€P99å»¶è¿Ÿã€å†…å­˜ä½¿ç”¨

#### æé™æµ‹è¯•åœºæ™¯ï¼š

1. ä¸‡çº§å¹¶å‘æµ‹è¯•ï¼š10000å®¢æˆ·ç«¯ï¼ŒéªŒè¯æ¡†æ¶æé™
2. é•¿æ—¶é—´ç¨³å®šæ€§ï¼š24å°æ—¶ä¸é—´æ–­å‹åŠ›æµ‹è¯•
3. å†…å­˜æ³„æ¼æµ‹è¯•ï¼švalgrindæ·±åº¦æ£€æŸ¥
4. æ•…éšœæ¢å¤æµ‹è¯•ï¼šç½‘ç»œé—ªæ–­ã€è¿›ç¨‹é‡å¯ç­‰

#### å¯¹æ¯”æµ‹è¯•ç›®æ ‡ï¼š

| å¯¹æ¯”é¡¹ | ç›®æ ‡æ€§èƒ½ | éªŒè¯æ–¹æ³• |
|--------|---------|---------|
| vs nginx | QPS +50% | ç›¸åŒç¡¬ä»¶ç¯å¢ƒ |
| vs åŸç‰ˆmuduo | å»¶è¿Ÿ -20% | ç›¸åŒæµ‹è¯•ç”¨ä¾‹ |
| vs Go net/http | å¹¶å‘ +100% | ç›¸åŒåº”ç”¨åœºæ™¯ |

### ğŸ“Š é¢„æœŸä¼˜åŒ–æ•ˆæœæ€»è§ˆ

| ä¼˜åŒ–é˜¶æ®µ | æ—¶é—´æŠ•å…¥ | å…³é”®æŒ‡æ ‡æå‡ | æŠ€æœ¯ä»·å€¼ |
|---------|---------|-------------|---------|
| é˜¶æ®µä¸€ | 1-2å‘¨ | QPS +45%, P99å»¶è¿Ÿ -30% | è§£å†³æ ¸å¿ƒç“¶é¢ˆ |
| é˜¶æ®µäºŒ | 2-3å‘¨ | åŠŸèƒ½å®Œæ•´åº¦ +80% | æå‡å®ç”¨æ€§ |
| é˜¶æ®µä¸‰ | 3-4å‘¨ | åå +30%, å»¶è¿Ÿ -50% | è¾¾åˆ°ä¸šç•Œé¢†å…ˆ |

**æ€»è®¡æŠ•å…¥ï¼š** 6-9å‘¨ï¼Œå®ç°ä»ä¼˜ç§€åˆ°å“è¶Šçš„è·¨è¶Šã€‚

### ğŸ’¼ ç®€å†ä¸é¢è¯•ä»·å€¼

#### å½“å‰å¯å±•ç¤ºçš„äº®ç‚¹ï¼š
- ç‹¬ç«‹å®ç°é«˜æ€§èƒ½Reactorç½‘ç»œæ¡†æ¶ï¼Œ5000å¹¶å‘ä¸‹QPS 15ä¸‡+
- å¹³å‡å»¶è¿Ÿ<5msï¼ŒP99å»¶è¿Ÿ<10msï¼Œè¾¾åˆ°ç”Ÿäº§çº§æ ‡å‡†
- å®Œæ•´çš„å¤šçº¿ç¨‹æ¨¡å‹å’Œå†…å­˜ç®¡ç†å®ç°
- é€šè¿‡46ä¸ªå•å…ƒæµ‹è¯•éªŒè¯æ ¸å¿ƒåŠŸèƒ½

#### ä¼˜åŒ–åå¯å±•ç¤ºçš„äº®ç‚¹ï¼š
- æ·±åº¦ä¼˜åŒ–ç½‘ç»œæ¡†æ¶ï¼Œä¸‡çº§å¹¶å‘ä¸‹QPS 20ä¸‡+ï¼ŒP99å»¶è¿Ÿ<5ms
- å®ç°å®šæ—¶å™¨ã€å¼‚æ­¥æ—¥å¿—ã€HTTPåè®®ç­‰å®Œæ•´ç”Ÿæ€
- è®¾è®¡é›¶æ‹·è´ä¼ è¾“ã€å†…å­˜æ± ç­‰é«˜æ€§èƒ½ç»„ä»¶
- å»ºç«‹å®Œæ•´çš„æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ä½“ç³»
- æ€§èƒ½è¶…è¶Šnginxï¼Œåª²ç¾åŸç‰ˆmuduo

#### é¢è¯•è¯é¢˜å‡†å¤‡ï¼š
1. æ¶æ„è®¾è®¡ï¼šReactor vs Proactorï¼ŒOne Loop Per Thread
2. æ€§èƒ½ä¼˜åŒ–ï¼šé”ç«äº‰è§£å†³ã€å†…å­˜æ± è®¾è®¡ã€å»¶è¿Ÿä¼˜åŒ–
3. ç½‘ç»œåŸç†ï¼šTCPçŠ¶æ€æœºã€epollç»†èŠ‚ã€é›¶æ‹·è´
4. å·¥ç¨‹å®è·µï¼šæµ‹è¯•ç­–ç•¥ã€æ€§èƒ½åˆ†æã€é—®é¢˜æ’æŸ¥

### ğŸ¯ ç«‹å³è¡ŒåŠ¨å»ºè®®

#### ç¬¬ä¸€å‘¨è®¡åˆ’ï¼š

**Day 1-2ï¼šæ€§èƒ½ç“¶é¢ˆå®šä½**
```bash
# 1. ä½¿ç”¨perfå®šä½çƒ­ç‚¹
perf record -g ./benchmark/echo_bench --clients=2000
perf report

# 2. é”ç«äº‰åˆ†æ
perf lock record ./benchmark/echo_bench --clients=2000
perf lock report

# 3. å†…å­˜åˆ†æ
valgrind --tool=massif ./benchmark/echo_bench --clients=1000
```

**Day 3-4ï¼šå®ç°åˆ†ç‰‡è¿æ¥ç®¡ç†**
- ä¿®æ”¹TcpServerçš„è¿æ¥å­˜å‚¨ç»“æ„
- å®ç°ShardedConnectionManager
- éªŒè¯é”ç«äº‰å‡å°‘æ•ˆæœ

**Day 5ï¼šå®ç°Bufferå¯¹è±¡æ± **
- æ·»åŠ BufferCacheå•ä¾‹
- ä¿®æ”¹TcpConnectionä½¿ç”¨ç¼“å­˜
- æµ‹è¯•å†…å­˜åˆ†é…æ€§èƒ½æå‡

**å‘¨æœ«ï¼š** è¿è¡Œä¼˜åŒ–ååŸºå‡†æµ‹è¯•ï¼Œç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š

#### éœ€è¦çš„å…·ä½“æ”¯æŒï¼š
1. æ˜¯å¦éœ€è¦æˆ‘æä¾›åˆ†ç‰‡è¿æ¥ç®¡ç†å™¨çš„å®Œæ•´å®ç°ä»£ç ï¼Ÿ
2. æ˜¯å¦éœ€è¦è¯¦ç»†çš„æ€§èƒ½åˆ†æè„šæœ¬å’Œå¯¹æ¯”æŠ¥å‘Šæ¨¡æ¿ï¼Ÿ
3. æ˜¯å¦éœ€è¦å®šæ—¶å™¨æ¨¡å—çš„é€æ­¥å®ç°æŒ‡å¯¼ï¼Ÿ

### ğŸ“ˆ æ€»ç»“

æ‚¨çš„ re_muduo é¡¹ç›®å·²ç»æ˜¯ä¸€ä¸ªéå¸¸æˆåŠŸçš„ç½‘ç»œæ¡†æ¶å®ç°ã€‚ç›®å‰çš„æ€§èƒ½è¡¨ç°åœ¨åŒç±»é¡¹ç›®ä¸­å±äºä¼˜ç§€æ°´å¹³ï¼Œå…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„åŸºç¡€èƒ½åŠ›ã€‚

**æ ¸å¿ƒä¼˜åŠ¿å·²ç¡®ç«‹ï¼š**
- âœ… é«˜æ€§èƒ½ï¼šå°åŒ…31.9ä¸‡QPSï¼Œå¤§åŒ…15GB/såå
- âœ… é«˜å¹¶å‘ï¼š5000è¿æ¥ç¨³å®šï¼Œé›¶å¤±è´¥
- âœ… ä½å»¶è¿Ÿï¼šå¹³å‡<5msï¼ŒP99<10ms
- âœ… é«˜å¯é ï¼šå®Œæ•´æµ‹è¯•ï¼Œä»£ç å¥å£®

**ä¼˜åŒ–æ–¹å‘æ˜ç¡®ï¼š**
- ğŸ”§ è§£å†³é«˜å¹¶å‘ä¸‹çš„é”ç«äº‰é—®é¢˜
- ğŸ”§ ä¼˜åŒ–å†…å­˜åˆ†é…ï¼Œå‡å°‘ç¢ç‰‡
- ğŸ”§ é™ä½å°¾éƒ¨å»¶è¿Ÿï¼Œæå‡ä¸€è‡´æ€§
- ğŸ”§ å®Œå–„ç”Ÿæ€åŠŸèƒ½ï¼Œæå‡å®ç”¨æ€§

**å»ºè®®ï¼š** ç«‹å³å¼€å§‹ç¬¬ä¸€é˜¶æ®µä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–æŠ•å…¥å°ã€è§æ•ˆå¿«ï¼Œèƒ½æ˜¾è‘—æå‡æ¡†æ¶æ€§èƒ½ã€‚å®Œæˆåï¼Œæ‚¨çš„é¡¹ç›®å°†å…·å¤‡å†²å‡»é¡¶çº§å¼€æºé¡¹ç›®çš„å®åŠ›ã€‚
