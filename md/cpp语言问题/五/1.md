

### 1. å®¹å™¨é€‰æ‹©ï¼š`std::vector<Channel*>` vs `std::unordered_map<int, Channel*>`

#### âœ… **`EventLoop::activeChannels_` ä½¿ç”¨ `std::vector<Channel*>`**

- **ç”¨é€”**ï¼šä¸´æ—¶å­˜æ”¾ **ä¸€æ¬¡ `poll()` è°ƒç”¨è¿”å›çš„æ´»è·ƒäº‹ä»¶é€šé“åˆ—è¡¨**ã€‚
- **è®¿é—®æ¨¡å¼**ï¼š
  - **é¡ºåºéå†**ï¼š`EventLoop::loop()` ä¸­ä¾æ¬¡è°ƒç”¨æ¯ä¸ª `Channel::handleEvent()`ã€‚
  - **ç”Ÿå‘½å‘¨æœŸçŸ­**ï¼šæ¯æ¬¡ `poll()` åæ¸…ç©ºï¼Œä¸‹æ¬¡é‡æ–°å¡«å……ã€‚
- **ä¸ºä»€ä¹ˆé€‰ `vector`ï¼Ÿ**
  | ç‰¹æ€§                | ä¼˜åŠ¿                                                                 |
  |---------------------|----------------------------------------------------------------------|
  | **å†…å­˜è¿ç»­**        | éå†æ—¶ CPU ç¼“å­˜å‹å¥½ï¼ˆcache-friendlyï¼‰ï¼Œå‡å°‘ cache miss                |
  | **æ— å“ˆå¸Œè®¡ç®—å¼€é”€**  | é¿å… `unordered_map` çš„å“ˆå¸Œå‡½æ•°è°ƒç”¨ï¼ˆé«˜é¢‘äº‹ä»¶å¤„ç†ä¸­å¯çœå¾®ç§’çº§å¼€é”€ï¼‰   |
  | **æ’å…¥é«˜æ•ˆ**        | `EpollPoller::poll()` ç›´æ¥ `push_back`ï¼ŒO(1) amortized               |

> ğŸ“Œ **å…³é”®ç‚¹**ï¼š`activeChannels_` æ˜¯**è¾“å‡ºå‚æ•°**ï¼Œåªéœ€é¡ºåºå¤„ç†ï¼Œæ— éœ€éšæœºæŸ¥æ‰¾ã€‚

#### âœ… **`EpollPoller::channels_` ä½¿ç”¨ `std::unordered_map<int, Channel*>`**

- **ç”¨é€”**ï¼šç®¡ç† **æ‰€æœ‰å·²æ³¨å†Œçš„ Channel**ï¼ˆfd â†’ Channel æ˜ å°„ï¼‰ã€‚
- **è®¿é—®æ¨¡å¼**ï¼š
  - **æ ¹æ® fd å¿«é€ŸæŸ¥æ‰¾**ï¼š`epoll_wait` è¿”å› fd åï¼Œéœ€ç«‹å³æ‰¾åˆ°å¯¹åº” `Channel`ã€‚
  - **é¢‘ç¹æ’å…¥/åˆ é™¤**ï¼šè¿æ¥å»ºç«‹/å…³é—­æ—¶æ³¨å†Œ/æ³¨é”€ Channelã€‚
- **ä¸ºä»€ä¹ˆé€‰ `unordered_map`ï¼Ÿ**
  | æ“ä½œ         | `unordered_map`       | `map` (çº¢é»‘æ ‘)       |
  |--------------|------------------------|-----------------------|
  | **æŸ¥æ‰¾**     | O(1) average           | O(log n)             |
  | **æ’å…¥**     | O(1) average           | O(log n)             |
  | **å†…å­˜å¸ƒå±€** | å“ˆå¸Œæ¡¶ + é“¾è¡¨          | æ ‘èŠ‚ç‚¹ï¼ˆæŒ‡é’ˆè·³è½¬å¤šï¼‰  |

> ğŸ’¡ **muduo çš„æ€§èƒ½è€ƒé‡**ï¼š  
> åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ˆå¦‚ 10k+ è¿æ¥ï¼‰ï¼Œ`unordered_map` çš„ O(1) æŸ¥æ‰¾æ¯” `map` çš„ O(log n) æ›´ä¼˜ï¼Œä¸”é¿å…æ ‘æ—‹è½¬å¼€é”€ã€‚

---

### 2. `TcpServer::connectionMap_`ï¼šæŒ‰åç§°æŸ¥æ‰¾ vs æŒ‰æ—¶é—´æ’åº

#### âœ… **å½“å‰è®¾è®¡ï¼š`std::unordered_map<std::string, TcpConnectionPtr>`**
- **é€‚ç”¨åœºæ™¯**ï¼šä»…éœ€ **æŒ‰è¿æ¥åï¼ˆå¦‚ "192.168.1.1:8080"ï¼‰å¿«é€ŸæŸ¥æ‰¾/åˆ é™¤**ã€‚
- **ä¼˜åŠ¿**ï¼šO(1) å¹³å‡æŸ¥æ‰¾ï¼Œé€‚åˆé«˜é¢‘è¿æ¥ç®¡ç†ã€‚

#### ğŸ” **è‹¥éœ€æŒ‰è¿æ¥å»ºç«‹æ—¶é—´æ’åºéå†ï¼Ÿ**
- **é—®é¢˜**ï¼š`unordered_map` **æ— åº**ï¼Œæ— æ³•ç›´æ¥æŒ‰æ—¶é—´éå†ã€‚
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  1. **æ–¹æ¡ˆä¸€ï¼šæ”¹ç”¨ `std::map<std::string, TcpConnectionPtr>`**
     - **ä¼˜ç‚¹**ï¼šæŒ‰é”®ï¼ˆè¿æ¥åï¼‰æœ‰åºï¼Œä½†**æ— æ³•æŒ‰æ—¶é—´æ’åº**ï¼ˆé™¤éè¿æ¥ååŒ…å«æ—¶é—´æˆ³ï¼‰ã€‚
     - **ç¼ºç‚¹**ï¼šO(log n) æ“ä½œï¼Œæ€§èƒ½ä½äº `unordered_map`ã€‚

  2. **æ–¹æ¡ˆäºŒï¼šåŒå®¹å™¨ç»´æŠ¤ï¼ˆæ¨èï¼‰**
     ```cpp
     // æŒ‰åç§°å¿«é€ŸæŸ¥æ‰¾
     std::unordered_map<std::string, TcpConnectionPtr> connectionMap_;
     // æŒ‰æ—¶é—´é¡ºåºéå†
     std::list<TcpConnectionPtr> connectionList_; // æˆ– vector + æ—¶é—´æˆ³
     ```
     - **æ’å…¥**ï¼šåŒæ—¶åŠ å…¥ `map` å’Œ `list`ã€‚
     - **åˆ é™¤**ï¼šä» `map` æ‰¾åˆ°å¯¹è±¡ï¼Œå†ä» `list` ç§»é™¤ï¼ˆéœ€åœ¨ `TcpConnection` ä¸­ä¿å­˜ `list` è¿­ä»£å™¨ï¼‰ã€‚
     - **éå†**ï¼šç›´æ¥éå† `list`ï¼ˆæŒ‰æ’å…¥é¡ºåºï¼‰ã€‚

  3. **æ–¹æ¡ˆä¸‰ï¼šåœ¨ `TcpConnection` ä¸­å­˜å‚¨æ—¶é—´æˆ³**
     ```cpp
     class TcpConnection {
         Timestamp createTime_;
     };
     // éå†æ—¶æ”¶é›†æ‰€æœ‰è¿æ¥ï¼ŒæŒ‰ createTime_ æ’åº
     std::vector<TcpConnectionPtr> conns;
     for (auto& [name, conn] : connectionMap_) {
         conns.push_back(conn);
     }
     std::sort(conns.begin(), conns.end(), [](auto& a, auto& b) {
         return a->createTime() < b->createTime();
     });
     ```
     - **é€‚ç”¨åœºæ™¯**ï¼šä½é¢‘éå†ï¼ˆå¦‚ç›‘æ§æ¥å£ï¼‰ï¼Œé¿å…åŒå®¹å™¨ç»´æŠ¤å¼€é”€ã€‚

> ğŸ“Œ **å·¥ç¨‹æƒè¡¡**ï¼š  
> muduo é»˜è®¤é€‰æ‹© `unordered_map` æ˜¯å› ä¸º **â€œæŒ‰åç§°ç®¡ç†è¿æ¥â€æ˜¯æ ¸å¿ƒéœ€æ±‚**ï¼Œè€Œâ€œæŒ‰æ—¶é—´éå†â€å±äºæ¬¡è¦éœ€æ±‚ï¼Œå¯é€šè¿‡æ–¹æ¡ˆä¸‰ä¸´æ—¶å®ç°ã€‚

---

### 3. `Buffer::findCRLF()` ä¸ `std::search`

#### âœ… `std::search` çš„åŠŸèƒ½ï¼š
- **ä½œç”¨**ï¼šåœ¨ `[first1, last1)` èŒƒå›´å†…æœç´¢å­åºåˆ— `[first2, last2)`ã€‚
- **åœ¨ `findCRLF` ä¸­çš„åº”ç”¨**ï¼š
  ```cpp
  const char* CRLF = "\r\n";
  auto it = std::search(peek(), beginWrite(), CRLF, CRLF + 2);
  if (it != beginWrite()) {
      return it; // æ‰¾åˆ° CRLF ä½ç½®
  }
  ```

#### ğŸ” è‡ªå·±å®ç°çš„å¤§è‡´æ€è·¯ï¼š
```cpp
const char* Buffer::findCRLF() {
    const char* p = peek();
    const char* end = beginWrite();
    while (p < end - 1) { // è‡³å°‘ä¿ç•™ 2 å­—èŠ‚
        if (p[0] == '\r' && p[1] == '\n') {
            return p;
        }
        ++p;
    }
    return nullptr;
}
```
- **æ—¶é—´å¤æ‚åº¦**ï¼šO(n*m)ï¼Œå…¶ä¸­ n=ç¼“å†²åŒºé•¿åº¦ï¼Œm=æ¨¡å¼é•¿åº¦ï¼ˆæ­¤å¤„ m=2ï¼Œå¯ä¼˜åŒ–ä¸º O(n)ï¼‰ã€‚
- **ä¼˜åŒ–æ–¹å‘**ï¼šå¯¹å›ºå®šæ¨¡å¼ï¼ˆå¦‚ "\r\n"ï¼‰ï¼Œæ‰‹åŠ¨å¾ªç¯æ¯” `std::search` æ›´å¿«ï¼ˆé¿å…å‡½æ•°è°ƒç”¨å¼€é”€ï¼‰ã€‚

> ğŸ’¡ **muduo çš„å®é™…é€‰æ‹©**ï¼š  
> åŸå§‹ muduo ä½¿ç”¨æ‰‹åŠ¨å¾ªç¯å®ç° `findCRLF`ï¼Œå› ä¸ºï¼š
> - æ¨¡å¼å›ºå®šï¼ˆ"\r\n" æˆ– "\n"ï¼‰
> - é¿å…é€šç”¨ç®—æ³•çš„æŠ½è±¡å¼€é”€
> - å¯é’ˆå¯¹å°æ¨¡å¼åšç‰¹æ®Šä¼˜åŒ–

---

### æ€»ç»“è¡¨

| é—®é¢˜ç‚¹                         | å…³é”®ç»“è®º                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| `activeChannels_` ç”¨ `vector`  | é¡ºåºéå† + ä¸´æ—¶å­˜å‚¨ â†’ å†…å­˜è¿ç»­ã€ç¼“å­˜å‹å¥½ã€æ— å“ˆå¸Œå¼€é”€                     |
| `channels_` ç”¨ `unordered_map` | æ ¹æ® fd å¿«é€ŸæŸ¥æ‰¾ â†’ O(1) å¹³å‡å¤æ‚åº¦ï¼Œä¼˜äº `map` çš„ O(log n)               |
| `connectionMap_` æŒ‰æ—¶é—´æ’åº    | éœ€é¢å¤–æ•°æ®ç»“æ„ï¼ˆå¦‚ `list`ï¼‰æˆ–ä¸´æ—¶æ’åºï¼›é»˜è®¤ `unordered_map` ä¼˜å…ˆæŸ¥æ‰¾ç¤ºèƒ½ |
| `std::search` vs æ‰‹åŠ¨å¾ªç¯      | é€šç”¨åœºæ™¯ç”¨ `std::search`ï¼›å›ºå®šå°æ¨¡å¼ç”¨æ‰‹åŠ¨å¾ªç¯æ›´é«˜æ•ˆ                      |

