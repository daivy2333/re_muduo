
---

### 1. RAII åŸç†ä¸ `Socket` ç±»çš„å®ç°

#### âœ… ä»€ä¹ˆæ˜¯ RAIIï¼Ÿ
> **RAIIï¼ˆResource Acquisition Is Initializationï¼‰** æ˜¯ C++ çš„æ ¸å¿ƒèŒƒå¼ï¼š  
> **å°†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸Šã€‚èµ„æºåœ¨å¯¹è±¡æ„é€ æ—¶è·å–ï¼Œåœ¨å¯¹è±¡ææ„æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚**

#### ğŸ” `Socket` ç±»å¦‚ä½•ä½“ç° RAIIï¼Ÿ

- **æ„é€ å‡½æ•°è·å–èµ„æº**ï¼š
  ```cpp
  // Socket.cpp
  Socket::Socket(int sockfd) 
      : sockfd_(sockfd) {
      // å¯é€‰ï¼šè®¾ç½® socket é€‰é¡¹ï¼ˆå¦‚ SO_REUSEADDRï¼‰
  }
  ```
  - `sockfd_` æ˜¯ä¸€ä¸ª **æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰**ï¼Œä»£è¡¨æ“ä½œç³»ç»Ÿèµ„æºï¼ˆå†…æ ¸ä¸­çš„ socket å¯¹è±¡ï¼‰ã€‚
  - æ„é€ æ—¶â€œæ¥ç®¡â€è¯¥ fdï¼Œæˆä¸ºå…¶å”¯ä¸€ç®¡ç†è€…ã€‚

- **ææ„å‡½æ•°é‡Šæ”¾èµ„æº**ï¼š
  ```cpp
  Socket::~Socket() {
      if (sockfd_ >= 0) {
          ::close(sockfd_);  // ç³»ç»Ÿè°ƒç”¨å…³é—­ fd
      }
  }
  ```
  - æ— è®º `Socket` å¯¹è±¡å¦‚ä½•ç¦»å¼€ä½œç”¨åŸŸï¼ˆæ­£å¸¸è¿”å›ã€å¼‚å¸¸æŠ›å‡ºï¼‰ï¼Œææ„å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ã€‚
  - **ç¡®ä¿ fd ä¸ä¼šæ³„æ¼**ï¼Œå³ä½¿ä¸­é—´å‘ç”Ÿå¼‚å¸¸ã€‚

#### ğŸ’¡ RAII å¦‚ä½•é¿å…èµ„æºæ³„æ¼ï¼Ÿ

| åœºæ™¯                     | æ—  RAIIï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰                          | æœ‰ RAIIï¼ˆ`Socket` å°è£…ï¼‰                     |
|--------------------------|---------------------------------------------|---------------------------------------------|
| æ­£å¸¸æµç¨‹                 | éœ€æ˜¾å¼ `close(fd)`                          | è‡ªåŠ¨ææ„ï¼Œæ— éœ€å¹²é¢„                          |
| å¼‚å¸¸æŠ›å‡º                 | `close(fd)` å¯èƒ½è¢«è·³è¿‡ â†’ **fd æ³„æ¼**        | æ ˆå±•å¼€ï¼ˆstack unwindingï¼‰è§¦å‘ææ„ â†’ **å®‰å…¨é‡Šæ”¾** |
| å¤šåˆ†æ”¯é€»è¾‘               | æ¯ä¸ªåˆ†æ”¯éƒ½éœ€ `close(fd)`ï¼Œæ˜“é—æ¼            | ä¸€æ¬¡ææ„ï¼Œè¦†ç›–æ‰€æœ‰è·¯å¾„                      |

> ğŸ“Œ **å…³é”®ä¼˜åŠ¿**ï¼šRAII å°†**èµ„æºç®¡ç†è´£ä»»**ä»ç¨‹åºå‘˜è½¬ç§»åˆ°**ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶**ï¼Œå®ç°**å¼‚å¸¸å®‰å…¨ï¼ˆexception-safeï¼‰** çš„èµ„æºç®¡ç†ã€‚

---

### 2. å¦‚ä½•è®¾è®¡ `Socket` æ„é€ å‡½æ•°ä»¥â€œç§»äº¤â€å·²æœ‰ fdï¼Ÿ

#### âœ… è®¾è®¡ç›®æ ‡ï¼š
- åœ¨ `Acceptor::accept()` ä¸­ï¼Œ`::accept()` è¿”å›ä¸€ä¸ªæ–°è¿æ¥çš„ `connfd`ã€‚
- éœ€è¦å°†è¿™ä¸ª `connfd` **å®‰å…¨åœ°ç§»äº¤ç»™ `Socket` å¯¹è±¡ç®¡ç†**ï¼Œé¿å…è£¸ fd æ“ä½œã€‚

#### ğŸ”§ æ­£ç¡®æ„é€ å‡½æ•°è®¾è®¡ï¼š
```cpp
// Socket.h
class Socket : noncopyable {
public:
    explicit Socket(int sockfd);  // æ¥ç®¡å·²æœ‰ fd
    // ... å…¶ä»–æˆå‘˜
private:
    int sockfd_;
};
```

#### ğŸ›  ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨ `Acceptor::handleRead` ä¸­ï¼‰ï¼š
```cpp
// Acceptor.cpp
void Acceptor::handleRead() {
    InetAddress peerAddr;
    int connfd = ::accept4(listenFd_, peerAddr.getSockAddr(), ...);
    if (connfd >= 0) {
        // å°† connfd ç§»äº¤ç»™ Socket å¯¹è±¡
        Socket connSock(connfd);  // RAII å¼€å§‹ï¼šconnSock è´Ÿè´£ç®¡ç† connfd
        
        // ä¼ é€’ç»™ TcpConnectionï¼ˆé€šå¸¸é€šè¿‡ shared_ptrï¼‰
        newConnectionCallback_(std::move(connSock), peerAddr);
        // æ³¨æ„ï¼šå®é™… muduo ä¸­å¯èƒ½ç›´æ¥ä¼  connfdï¼Œä½†æ›´å®‰å…¨çš„æ–¹å¼æ˜¯ä¼ é€’ Socket å¯¹è±¡
    }
}
```

#### âš ï¸ å…³é”®è®¾è®¡è¦ç‚¹ï¼š

1. **`explicit` å…³é”®å­—**  
   é˜²æ­¢éšå¼è½¬æ¢ï¼ˆå¦‚ `Socket s = 3;`ï¼‰ï¼Œç¡®ä¿ç”¨æˆ·æ˜ç¡®çŸ¥é“åœ¨æ¥ç®¡ fdã€‚

2. **ç¦æ­¢æ‹·è´ï¼Œå…è®¸ç§»åŠ¨ï¼ˆè§å‰æ–‡ï¼‰**  
   - ç»§æ‰¿ `noncopyable`ï¼šé˜²æ­¢ä¸¤ä¸ª `Socket` å…±äº«åŒä¸€ fdã€‚
   - æä¾›ç§»åŠ¨æ„é€ /èµ‹å€¼ï¼šæ”¯æŒèµ„æºè½¬ç§»ï¼ˆå¦‚è¿”å› `Socket` å¯¹è±¡ï¼‰ã€‚

3. **fd æœ‰æ•ˆæ€§æ£€æŸ¥**  
   ææ„å‡½æ•°ä¸­æ£€æŸ¥ `sockfd_ >= 0`ï¼Œé¿å…å¯¹æ— æ•ˆ fd è°ƒç”¨ `close()`ã€‚

4. **æ‰€æœ‰æƒè¯­ä¹‰æ¸…æ™°**  
   ä¸€æ—¦ `Socket` å¯¹è±¡åˆ›å»ºï¼Œ**å®ƒå°±æˆä¸º fd çš„å”¯ä¸€æ‰€æœ‰è€…**ã€‚è°ƒç”¨è€…ä¸åº”å†æ“ä½œè¯¥ fdã€‚

> ğŸ’¡ **muduo çš„å®é™…åšæ³•**ï¼š  
> åœ¨åŸå§‹ muduo ä¸­ï¼Œ`TcpConnection` ç›´æ¥æ¥æ”¶ `int sockfd`ï¼Œå¹¶åœ¨å†…éƒ¨æ„é€  `Socket`ã€‚ä½†æ›´ç°ä»£çš„åšæ³•æ˜¯**ä¼ é€’ `Socket` å¯¹è±¡**ï¼ˆæˆ– `unique_fd`ï¼‰ï¼Œä»¥æ˜¾å¼è¡¨è¾¾æ‰€æœ‰æƒè½¬ç§»ã€‚

---

### æ‰©å±•å»ºè®®ï¼šæ›´å®‰å…¨çš„ fd å°è£…ï¼ˆå¯é€‰ï¼‰

è‹¥æƒ³è¿›ä¸€æ­¥å¼ºåŒ– RAIIï¼Œå¯å®šä¹‰ä¸“ç”¨ç±»å‹ï¼š
```cpp
struct UniqueFd {
    int fd = -1;
    UniqueFd(int f) : fd(f) {}
    ~UniqueFd() { if (fd >= 0) ::close(fd); }
    UniqueFd(const UniqueFd&) = delete;
    UniqueFd& operator=(const UniqueFd&) = delete;
    UniqueFd(UniqueFd&& other) noexcept : fd(other.fd) { other.fd = -1; }
};
```
ç„¶å `Socket` æŒæœ‰ `UniqueFd`ï¼Œå®ç°åŒé‡ä¿éšœã€‚

---

### æ€»ç»“

| é—®é¢˜ç‚¹                         | å…³é”®ç»“è®º                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| RAII ä¸ `Socket`               | æ„é€ è·å– fdï¼Œææ„è‡ªåŠ¨ `close`ï¼Œå®ç°å¼‚å¸¸å®‰å…¨çš„èµ„æºç®¡ç†                    |
| ç§»äº¤å·²æœ‰ fd çš„æ„é€ å‡½æ•°         | `explicit Socket(int sockfd)`ï¼Œæ˜ç¡®æ¥ç®¡æ‰€æœ‰æƒï¼Œé…åˆç§»åŠ¨è¯­ä¹‰æ”¯æŒèµ„æºè½¬ç§»   |

