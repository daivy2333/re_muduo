
---

### 1. `Poller` æŠ½è±¡åŸºç±»ä¸ç»§æ‰¿ï¼šç›®çš„ä¸è®¾è®¡æ¨¡å¼

#### âœ… æ ¸å¿ƒç›®çš„ï¼š**è¿è¡Œæ—¶å¤šæ€ + è§£è€¦ I/O å¤šè·¯å¤ç”¨æœºåˆ¶**

- **æŠ½è±¡æ¥å£å®šä¹‰**ï¼š
  ```cpp
  class Poller : noncopyable {
  public:
      virtual ~Poller() = default;
      virtual Timestamp poll(int timeoutMs, ChannelList* activeChannels) = 0;
      virtual void updateChannel(Channel* channel) = 0;
      virtual void removeChannel(Channel* channel) = 0;
  };
  ```
  æ‰€æœ‰å…·ä½“ Pollerï¼ˆå¦‚ `EpollPoller`ã€æœªæ¥å¯æ‰©å±•çš„ `KqueuePoller`ï¼‰å¿…é¡»å®ç°è¿™äº›æ¥å£ã€‚

- **ä¸ºä»€ä¹ˆç”¨è™šå‡½æ•°ï¼Ÿ**
  - **ç»Ÿä¸€è°ƒç”¨å…¥å£**ï¼š`EventLoop` åªæŒæœ‰ `std::unique_ptr<Poller>`ï¼Œæ— éœ€å…³å¿ƒåº•å±‚æ˜¯ `epoll` è¿˜æ˜¯ `kqueue`ã€‚
  - **è¿è¡Œæ—¶é€‰æ‹©**ï¼šå¯é€šè¿‡å·¥å‚å‡½æ•°åŠ¨æ€åˆ›å»ºä¸åŒ Pollerï¼ˆå¦‚æ ¹æ® OS è‡ªåŠ¨é€‰æ‹©ï¼‰ã€‚
  - **æµ‹è¯•å‹å¥½**ï¼šå¯æ³¨å…¥ MockPoller è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

#### ğŸ¯ è®¾è®¡æ¨¡å¼ï¼š**ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰**

- **è§’è‰²æ˜ å°„**ï¼š
  - **Context**ï¼š`EventLoop`ï¼ˆä½¿ç”¨ Pollerï¼‰
  - **Strategy**ï¼š`Poller`ï¼ˆæŠ½è±¡ç­–ç•¥ï¼‰
  - **ConcreteStrategy**ï¼š`EpollPoller`ï¼ˆå…·ä½“ç­–ç•¥ï¼‰

> ğŸ’¡ **ä¸ºä½•ä¸æ˜¯æ¨¡æ¿ï¼ˆç¼–è¯‘æ—¶å¤šæ€ï¼‰ï¼Ÿ**  
> muduo é€‰æ‹©è¿è¡Œæ—¶å¤šæ€è€Œé CRTPï¼Œæ˜¯å› ä¸ºï¼š
> - I/O å¤šè·¯å¤ç”¨æœºåˆ¶å·®å¼‚å¤§ï¼ˆ`epoll` vs `kqueue`ï¼‰ï¼Œæ¥å£ä¸å®Œå…¨ä¸€è‡´ï¼›
> - è¿è¡Œæ—¶åˆ‡æ¢æ›´çµæ´»ï¼ˆå¦‚è°ƒè¯•æ—¶åˆ‡æ¢å®ç°ï¼‰ï¼›
> - æ€§èƒ½æŸå¤±å¯æ¥å—ï¼ˆè™šå‡½æ•°è°ƒç”¨åœ¨äº‹ä»¶å¾ªç¯ä¸­å æ¯”æå°ï¼‰ã€‚

---

### 2. `noncopyable` æƒ¯ç”¨æ³•ï¼šå®ç°ä¸æ¼”è¿›

#### âœ… C++98/03 å®ç°ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
```cpp
class noncopyable {
protected:
    noncopyable() = default;
    ~noncopyable() = default;

private:
    noncopyable(const noncopyable&) = delete;            // æˆ– private + æœªå®šä¹‰
    noncopyable& operator=(const noncopyable&) = delete; // æˆ– private + æœªå®šä¹‰
};
```

#### âœ… C++11 æ¨èå®ç°ï¼ˆä½¿ç”¨ `=delete`ï¼‰ï¼š
```cpp
class noncopyable {
protected:
    constexpr noncopyable() = default;
    ~noncopyable() = default;

public:
    noncopyable(const noncopyable&) = delete;
    noncopyable& operator=(const noncopyable&) = delete;
};
```

#### ğŸ” `=delete` ç›¸æ¯” `private` çš„ä¼˜åŠ¿ï¼š

| å¯¹æ¯”é¡¹                | `private` å£°æ˜                          | `=delete`                              |
|-----------------------|------------------------------------------|----------------------------------------|
| **é”™è¯¯æç¤ºæ—¶æœº**      | é“¾æ¥æ—¶é”™è¯¯ï¼ˆè‹¥æœªå®šä¹‰ï¼‰æˆ–ç¼–è¯‘æ—¶æ¨¡ç³Šé”™è¯¯   | **ç¼–è¯‘æ—¶æŠ¥é”™**ï¼Œæ˜ç¡®æç¤ºâ€œdeleted functionâ€ |
| **å¯è®¿é—®æ€§**          | è‹¥åœ¨ç±»å†…è°ƒç”¨ï¼Œä»å¯ç¼–è¯‘ï¼ˆä½†é“¾æ¥å¤±è´¥ï¼‰     | ä»»ä½•ä¸Šä¸‹æ–‡è°ƒç”¨å‡ç«‹å³æŠ¥é”™               |
| **è¯­ä¹‰æ¸…æ™°åº¦**        | éšæ™¦ï¼ˆéœ€é˜…è¯»æ³¨é‡Šï¼‰                       | æ˜¾å¼è¡¨è¾¾â€œç¦æ­¢æ­¤æ“ä½œâ€                   |
| **æ”¯æŒæ›´å¤šå‡½æ•°**      | ä»…é™æˆå‘˜å‡½æ•°                             | å¯åˆ é™¤ä»»æ„å‡½æ•°ï¼ˆå¦‚ `operator new`ï¼‰    |

> ğŸ“Œ **muduo é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š  
> æ‰€æœ‰**ç®¡ç†ç‹¬å èµ„æº**çš„ç±»éƒ½ç»§æ‰¿ `noncopyable`ï¼Œä¾‹å¦‚ï¼š
> - `EventLoop`
> - `Thread`
> - `Socket`
> - `Acceptor`
> - `TcpConnection`
> - `Poller` åŠå…¶å­ç±»

---

### 3. æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°è®¾è®¡

#### (1) `EventLoop` ææ„å‡½æ•°ä¸ºä½•éœ€â€œå¹³å‡¡â€ï¼Ÿèµ„æºé‡Šæ”¾ä½ç½®ï¼Ÿ

##### â“ è¯¯è§£æ¾„æ¸…ï¼š
â€œå¹³å‡¡ææ„å‡½æ•°â€ï¼ˆtrivial destructorï¼‰**å¹¶éå¿…éœ€**ã€‚å®é™…ä¸Šï¼Œ`EventLoop` **å¿…é¡»æ˜¾å¼é‡Šæ”¾èµ„æº**ï¼ˆå¦‚ `wakeupFd_`ã€`eventfd`ï¼‰ã€‚

##### âœ… æ­£ç¡®åšæ³•ï¼š
- **ææ„å‡½æ•°åº”å®Œæˆèµ„æºæ¸…ç†**ï¼š
  ```cpp
  EventLoop::~EventLoop() {
      ::close(wakeupFd_);       // å…³é—­ wakeup fd
      ::close(eventfd_);        // è‹¥ä½¿ç”¨ eventfd
      // æ³¨æ„ï¼špoller_ ç”± unique_ptr è‡ªåŠ¨ææ„
  }
  ```
- **å…³é”®çº¦æŸ**ï¼š  
  `EventLoop` **å¿…é¡»åœ¨å…¶æ‰€å±çº¿ç¨‹ä¸­ææ„**ï¼å› ä¸ºï¼š
  - `wakeupFd_` çš„è¯»å†™å¯èƒ½ä»åœ¨è¿›è¡Œï¼›
  - `poller_`ï¼ˆå¦‚ `epoll_fd`ï¼‰çš„å…³é—­å¿…é¡»åœ¨ loop çº¿ç¨‹ä¸­å®Œæˆã€‚

> ğŸ’¡ **muduo çš„å®‰å…¨å®è·µ**ï¼š  
> `EventLoop` é€šå¸¸ä½œä¸º `Thread` çš„å±€éƒ¨å˜é‡æˆ– `EventLoopThread` çš„æˆå‘˜ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸç”±çº¿ç¨‹æ§åˆ¶ï¼Œç¡®ä¿ææ„å‘ç”Ÿåœ¨æ­£ç¡®çº¿ç¨‹ã€‚

#### (2) `TcpConnection` æ„é€ å‡½æ•°ä¸ºä½• `private`ï¼Ÿè°å¯åˆ›å»ºï¼Ÿ

##### âœ… è®¾è®¡æ„å›¾ï¼š**å¼ºåˆ¶é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»ºï¼Œç¡®ä¿ç”Ÿå‘½å‘¨æœŸå®‰å…¨**

- **å£°æ˜**ï¼š
  ```cpp
  class TcpConnection : noncopyable {
      friend class TcpServer; // å”¯ä¸€å…è®¸åˆ›å»ºè€…
  private:
      TcpConnection(EventLoop* loop, const string& name, int sockfd,
                    const InetAddress& localAddr, const InetAddress& peerAddr);
  };
  ```

- **ä¸ºä»€ä¹ˆï¼Ÿ**
  1. **é˜²æ­¢ç”¨æˆ·è¯¯ç”¨**ï¼š  
     ç”¨æˆ·ä¸åº”ç›´æ¥ `new TcpConnection(...)`ï¼Œå› ä¸ºï¼š
     - éœ€è¦æ­£ç¡®æ³¨å†Œåˆ° `EventLoop`
     - éœ€è¦åˆå§‹åŒ– `Channel` å¹¶è®¾ç½®å›è°ƒ
     - éœ€è¦åŠ å…¥ `TcpServer::connectionMap_`
  2. **ç»Ÿä¸€åˆ›å»ºé€»è¾‘**ï¼š  
     æ‰€æœ‰è¿æ¥å¿…é¡»ç”± `TcpServer::newConnection()` åˆ›å»ºï¼Œç¡®ä¿ï¼š
     - `shared_ptr` æ­£ç¡®åˆå§‹åŒ–
     - å›è°ƒå‡½æ•°ï¼ˆ`connectionCallback_`ï¼‰è¢«è§¦å‘
     - èµ„æºï¼ˆsocketã€bufferï¼‰å®Œæ•´æ„å»º

> ğŸ“Œ **å…¸å‹åˆ›å»ºæµç¨‹**ï¼š
> ```cpp
> // Acceptor::handleRead()
> int connfd = accept(...);
> TcpConnectionPtr conn(new TcpConnection(loop, name, connfd, ...));
> connectionMap_[name] = conn; // TcpServer æŒæœ‰ shared_ptr
> conn->setConnectionCallback(connectionCallback_);
> conn->connectEstablished(); // æ³¨å†Œåˆ° EventLoop
> ```

---

### æ€»ç»“è¡¨

| é—®é¢˜ç‚¹                                | å…³é”®ç»“è®º                                                                 |
|---------------------------------------|--------------------------------------------------------------------------|
| `Poller` ç»§æ‰¿                         | ç­–ç•¥æ¨¡å¼ï¼Œè¿è¡Œæ—¶å¤šæ€è§£è€¦ I/O å¤šè·¯å¤ç”¨å®ç°                                |
| `noncopyable` å®ç°                    | C++11 ç”¨ `=delete` æ›´å®‰å…¨ã€æ¸…æ™°ï¼›ç”¨äºæ‰€æœ‰ç‹¬å èµ„æºç±»                      |
| `EventLoop` ææ„                      | **å¿…é¡»éå¹³å‡¡**ï¼Œæ˜¾å¼å…³é—­ `wakeupFd_`ï¼›ç¡®ä¿åœ¨ loop çº¿ç¨‹ä¸­ææ„              |
| `TcpConnection` ç§æœ‰æ„é€               | ä»… `TcpServer` å¯åˆ›å»ºï¼Œä¿è¯è¿æ¥ç”Ÿå‘½å‘¨æœŸå’Œèµ„æºåˆå§‹åŒ–å®Œæ•´æ€§                 |

