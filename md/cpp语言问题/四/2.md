

### 1. `Channel` çš„ `update()` / `remove()` æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿä¸ºä½•å¿…é¡»åœ¨ IO çº¿ç¨‹è°ƒç”¨ï¼Ÿ

#### âœ… ç»“è®ºï¼š**éçº¿ç¨‹å®‰å…¨ï¼Œå¿…é¡»åœ¨æ‰€å± `EventLoop` çº¿ç¨‹ä¸­è°ƒç”¨**

#### ğŸ” åŸå› åˆ†æï¼š

- **`Channel` ä¸ `Poller` çš„äº¤äº’æ— é”**ï¼š
  - `Channel::update()` æœ€ç»ˆè°ƒç”¨ `Poller::updateChannel(this)`ã€‚
  - `EpollPoller` å†…éƒ¨ä½¿ç”¨ `std::map<int, Channel*> channels_` ç®¡ç† fd åˆ° Channel çš„æ˜ å°„ã€‚
  - **è¯¥ map æ— ä»»ä½•äº’æ–¥é”ä¿æŠ¤**ï¼Œå› ä¸º muduo å‡è®¾æ‰€æœ‰ `Poller` æ“ä½œéƒ½åœ¨**åŒä¸€ä¸ª EventLoop çº¿ç¨‹**ä¸­æ‰§è¡Œã€‚

- **`epoll_ctl` çš„çº¿ç¨‹å®‰å…¨æ€§**ï¼š
  - Linux çš„ `epoll_ctl` æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆå†…æ ¸ä¼šåŠ é”ï¼‰ï¼Œä½† muduo çš„ `EpollPoller` å°è£…å±‚**æœªåšé¢å¤–åŒæ­¥**ã€‚
  - è‹¥å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨ `updateChannel`ï¼Œä¼šå¯¼è‡´ `channels_` map è¢«å¹¶å‘ä¿®æ”¹ â†’ **æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰**ã€‚

- **muduo çš„è®¾è®¡å¥‘çº¦**ï¼š
  > **æ‰€æœ‰å¯¹ `Channel` çš„ä¿®æ”¹ï¼ˆenable/disable events, update, removeï¼‰å¿…é¡»åœ¨å…¶æ‰€å±çš„ `EventLoop` çº¿ç¨‹ä¸­è¿›è¡Œã€‚**

#### ğŸ›  å¦‚ä½•ç¡®ä¿åœ¨æ­£ç¡®çº¿ç¨‹è°ƒç”¨ï¼Ÿ

- **é€šè¿‡ `EventLoop::assertInLoopThread()` æ–­è¨€**ï¼š
  ```cpp
  // Channel.cpp
  void Channel::update() {
      loop_->assertInLoopThread(); // è¿è¡Œæ—¶æ£€æŸ¥
      loop_->poller_->updateChannel(this);
  }
  ```
  - è¯¥æ–­è¨€åœ¨ Debug æ¨¡å¼ä¸‹æ•è·è·¨çº¿ç¨‹è°ƒç”¨é”™è¯¯ï¼Œä½†**ä¸æä¾›è¿è¡Œæ—¶ä¿æŠ¤**ï¼ˆRelease æ¨¡å¼å¯èƒ½å…³é—­ï¼‰ã€‚

- **æ­£ç¡®åšæ³•ï¼šé€šè¿‡ `EventLoop::runInLoop` è·¨çº¿ç¨‹è°ƒåº¦**ï¼š
  ```cpp
  // ä»å…¶ä»–çº¿ç¨‹å®‰å…¨åœ°æ›´æ–° Channel
  loop_->runInLoop([channel]() {
      channel->enableReading(); // åœ¨ loop çº¿ç¨‹ä¸­æ‰§è¡Œ
  });
  ```

> ğŸ’¡ **ä¸ºä»€ä¹ˆä¸åšå…¨é“¾è·¯çº¿ç¨‹å®‰å…¨ï¼Ÿ**  
> åŠ é”ä¼šå¼•å…¥æ€§èƒ½å¼€é”€ï¼ˆå°¤å…¶åœ¨é«˜é¢‘äº‹ä»¶å¤„ç†ä¸­ï¼‰ï¼Œè€Œ muduo çš„å“²å­¦æ˜¯ï¼š**å°†åŒæ­¥è´£ä»»äº¤ç»™ç”¨æˆ·ï¼Œåº“åªä¿è¯å•çº¿ç¨‹å†…çš„æ­£ç¡®æ€§**ã€‚

---

### 2. å›è°ƒï¼ˆå¦‚ `messageCallback_`ï¼‰çš„çº¿ç¨‹ç¯å¢ƒä¸æ•°æ®ç«äº‰

#### âœ… å›è°ƒæ‰§è¡Œçº¿ç¨‹ï¼š
- **`messageCallback_`ã€`connectionCallback_` ç­‰ç”¨æˆ·å›è°ƒå‡åœ¨ `TcpConnection` æ‰€å±çš„ `EventLoop` çº¿ç¨‹ä¸­æ‰§è¡Œ**ã€‚
  ```cpp
  // TcpConnection.cpp
  void TcpConnection::handleRead(Timestamp receiveTime) {
      loop_->assertInLoopThread();
      messageCallback_(shared_from_this(), &inputBuffer_, receiveTime); // â† åœ¨æ­¤çº¿ç¨‹è°ƒç”¨
  }
  ```

#### âš ï¸ ç”¨æˆ·ä¸šåŠ¡æ•°æ®çš„çº¿ç¨‹å®‰å…¨ï¼š
- **muduo ä¸æä¾›ä»»ä½•ä¿æŠ¤æœºåˆ¶**ï¼  
  å¦‚æœç”¨æˆ·åœ¨å›è°ƒä¸­è®¿é—®**å…¶ä»–çº¿ç¨‹å…±äº«çš„æ•°æ®**ï¼ˆå¦‚å…¨å±€ mapã€æ•°æ®åº“è¿æ¥æ± ï¼‰ï¼Œå¿…é¡»**è‡ªè¡ŒåŠ é”**ã€‚

#### ğŸ“Œ å…¸å‹å±é™©åœºæ™¯ï¼š
```cpp
// å…¨å±€å…±äº«æ•°æ®
std::unordered_map<std::string, int> g_userScores;

// ç”¨æˆ·å›è°ƒ
void onMessage(const TcpConnectionPtr& conn, Buffer* buf, Timestamp) {
    std::string user = parseUser(buf);
    g_userScores[user] += 10; // âŒ æ•°æ®ç«äº‰ï¼å¤šä¸ª EventLoop çº¿ç¨‹å¯èƒ½åŒæ—¶ä¿®æ”¹
}
```

#### âœ… æ­£ç¡®åšæ³•ï¼š
```cpp
std::mutex g_scoresMutex;

void onMessage(const TcpConnectionPtr& conn, Buffer* buf, Timestamp) {
    std::string user = parseUser(buf);
    {
        std::lock_guard<std::mutex> lock(g_scoresMutex);
        g_userScores[user] += 10;
    }
}
```

#### ğŸ’¡ muduo çš„çº¿ç¨‹å®‰å…¨è¾¹ç•Œæ€»ç»“ï¼š

| æ“ä½œç±»å‹                | æ˜¯å¦çº¿ç¨‹å®‰å…¨                     | è´£ä»»æ–¹   |
|-------------------------|----------------------------------|----------|
| `EventLoop::queueInLoop` | âœ… å®‰å…¨ï¼ˆå†…éƒ¨æœ‰ mutexï¼‰          | åº“       |
| `Channel` ä¿®æ”¹æ“ä½œ       | âŒ ä»…é™æ‰€å± EventLoop çº¿ç¨‹       | ç”¨æˆ·     |
| ç”¨æˆ·å›è°ƒæ‰§è¡Œ             | âœ… åœ¨å›ºå®š EventLoop çº¿ç¨‹         | åº“       |
| å›è°ƒä¸­çš„ä¸šåŠ¡æ•°æ®è®¿é—®     | âŒ ç”¨æˆ·éœ€è‡ªè¡ŒåŒæ­¥                | ç”¨æˆ·     |

> ğŸ“Œ **æ ¸å¿ƒåŸåˆ™**ï¼š  
> **muduo æ˜¯ä¸€ä¸ª *thread-compatible*ï¼ˆçº¿ç¨‹å…¼å®¹ï¼‰è€Œé *thread-safe*ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰çš„åº“ã€‚**  
> å®ƒå…è®¸å¤šçº¿ç¨‹ä½¿ç”¨ï¼Œä½†è¦æ±‚æ¯ä¸ªå¯¹è±¡ï¼ˆå¦‚ `EventLoop`, `Channel`ï¼‰åªè¢«ä¸€ä¸ªçº¿ç¨‹æ“ä½œã€‚

---

### æ€»ç»“è¡¨

| é—®é¢˜ç‚¹                         | å…³é”®ç»“è®º                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| `Channel` æ“ä½œçº¿ç¨‹å®‰å…¨         | âŒ éçº¿ç¨‹å®‰å…¨ï¼›å¿…é¡»åœ¨æ‰€å± `EventLoop` çº¿ç¨‹è°ƒç”¨ï¼ˆé€šè¿‡ `assertInLoopThread` æ–­è¨€ï¼‰ |
| ç”¨æˆ·å›è°ƒä¸­çš„ä¸šåŠ¡æ•°æ®           | âŒ æ— ä¿æŠ¤ï¼›ç”¨æˆ·å¿…é¡»è‡ªè¡ŒåŠ é”æˆ–ä½¿ç”¨æ— é”æ•°æ®ç»“æ„                             |
| muduo çš„çº¿ç¨‹å®‰å…¨å“²å­¦           | åº“ä¿è¯ I/O çº¿ç¨‹å†…æ­£ç¡®æ€§ï¼Œä¸šåŠ¡é€»è¾‘åŒæ­¥ç”±ç”¨æˆ·è´Ÿè´£                           |

