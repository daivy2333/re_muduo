
## ä¸€ã€å…³ç³»ä¸èŒè´£

### 1. Channelã€Pollerã€EventLoop ä¸‰è€…å…³ç³»åŠå®Œæ•´äº‹ä»¶æµç¨‹

#### â–¶ è§’è‰²å®šä¹‰ï¼š
| ç»„ä»¶ | èŒè´£ |
|------|------|
| **`Channel`** | å°è£…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰åŠå…¶å…³æ³¨çš„äº‹ä»¶ï¼ˆ`events_`ï¼‰å’Œå°±ç»ªäº‹ä»¶ï¼ˆ`revents_`ï¼‰ï¼ŒæŒæœ‰ç”¨æˆ·å›è°ƒï¼ˆ`readCallback_` ç­‰ï¼‰ |
| **`Poller`ï¼ˆå¦‚ `EpollPoller`ï¼‰** | ç®¡ç†å¤šä¸ª `Channel`ï¼Œè°ƒç”¨ `epoll_ctl` æ³¨å†Œ/ä¿®æ”¹äº‹ä»¶ï¼Œè°ƒç”¨ `epoll_wait` è·å–å°±ç»ªäº‹ä»¶ |
| **`EventLoop`** | é©±åŠ¨æ•´ä¸ªæµç¨‹ï¼šè°ƒç”¨ `Poller::poll()` è·å–å°±ç»ª `Channel`ï¼Œç„¶åè°ƒç”¨å…¶ `handleEvent()` |

#### â–¶ å®Œæ•´äº‹ä»¶æµç¨‹ï¼ˆä»¥ TCP è¯»äº‹ä»¶ä¸ºä¾‹ï¼‰ï¼š

1. **æ³¨å†Œé˜¶æ®µï¼ˆåˆå§‹åŒ–ï¼‰**  
   - `TcpConnection` æ„é€ æ—¶åˆ›å»º `Channel`ï¼Œç»‘å®š socket fdï¼›
   - è°ƒç”¨ `channel->enableReading()` â†’ è®¾ç½® `events_ |= EPOLLIN`ï¼›
   - è°ƒç”¨ `eventLoop->updateChannel(channel)` â†’ æœ€ç»ˆè°ƒç”¨ `EpollPoller::updateChannel(channel)`ï¼›
   - `EpollPoller` æ‰§è¡Œ `epoll_ctl(EPOLL_CTL_ADD, fd, events_)`ï¼Œå¹¶å°† `fd â†’ channel*` å­˜å…¥ `channels_` mapã€‚

2. **ç­‰å¾…é˜¶æ®µ**  
   - `EventLoop::loop()` è°ƒç”¨ `poller_->poll()`ï¼›
   - `EpollPoller::poll()` è°ƒç”¨ `epoll_wait()`ï¼Œé˜»å¡ç›´åˆ°æœ‰äº‹ä»¶å°±ç»ªï¼›
   - å†…æ ¸è¿”å›å°±ç»ªäº‹ä»¶æ•°ç»„ï¼ˆ`struct epoll_event[]`ï¼‰ã€‚

3. **åˆ†å‘é˜¶æ®µ**  
   - `EpollPoller::fillActiveChannels()` æ ¹æ®å°±ç»ª fd æŸ¥æ‰¾å¯¹åº”çš„ `Channel*`ï¼Œå¡«å…¥ `activeChannels_`ï¼›
   - `EventLoop` éå† `activeChannels_`ï¼Œå¯¹æ¯ä¸ª `channel` è°ƒç”¨ `channel->handleEvent(receivedTime)`ï¼›
   - `Channel::handleEvent()` æ ¹æ® `revents_`ï¼ˆç”± `poll()` å¡«å……ï¼‰è°ƒç”¨ `readCallback_()`ã€‚

> âœ… **å…³é”®åä½œé“¾**ï¼š  
> `EventLoop` â†’ï¼ˆè°ƒç”¨ï¼‰â†’ `Poller::poll()` â†’ï¼ˆå¡«å……ï¼‰â†’ `activeChannels_` â†’ï¼ˆéå†è°ƒç”¨ï¼‰â†’ `Channel::handleEvent()`

---

### 2. `events_` ä¸ `revents_` çš„å«ä¹‰ä¸è®¾ç½®è€…

| æˆå‘˜ | å«ä¹‰ | è°è®¾ç½®ï¼Ÿ | è¯´æ˜ |
|------|------|--------|------|
| **`events_`** | **æœŸæœ›ç›‘å¬çš„äº‹ä»¶**ï¼ˆå¦‚ `EPOLLIN \| EPOLLET`ï¼‰ | ç”¨æˆ·ä»£ç ï¼ˆé€šè¿‡ `enableReading()` ç­‰ï¼‰ | è¡¨ç¤ºâ€œæˆ‘æƒ³ç›‘å¬å“ªäº›äº‹ä»¶â€ |
| **`revents_`** | **å®é™…å‘ç”Ÿçš„å°±ç»ªäº‹ä»¶**ï¼ˆå¦‚ `EPOLLIN`ï¼‰ | `Poller::poll()`ï¼ˆåœ¨ `fillActiveChannels` ä¸­ï¼‰ | è¡¨ç¤ºâ€œå“ªäº›äº‹ä»¶çœŸçš„å‘ç”Ÿäº†â€ |

#### â–¶ ç¤ºä¾‹ï¼š
```cpp
// ç”¨æˆ·å¯ç”¨è¯»äº‹ä»¶
channel->enableReading(); // â†’ events_ |= EPOLLIN

// EpollPoller::poll() å†…éƒ¨
for (int i = 0; i < numEvents; ++i) {
  Channel* channel = channels_[events[i].data.fd];
  channel->setRevents(events[i].events); // â† revents_ = events[i].events
}
```

> ğŸ” æ³¨æ„ï¼š`events_` æ˜¯ **input**ï¼ˆå‘Šè¯‰å†…æ ¸ç›‘å¬ä»€ä¹ˆï¼‰ï¼Œ`revents_` æ˜¯ **output**ï¼ˆå†…æ ¸å‘Šè¯‰æˆ‘ä»¬å‘ç”Ÿäº†ä»€ä¹ˆï¼‰ã€‚

---

### 3. `Channel::handleEvent()` çš„è°ƒç”¨è€…ä¸åˆ†å‘é€»è¾‘

#### â–¶ è°ƒç”¨è€…ï¼š
- **`EventLoop::loop()`** åœ¨æ¯æ¬¡å¾ªç¯ä¸­ï¼Œå¯¹ `activeChannels_` ä¸­çš„æ¯ä¸ª `Channel*` è°ƒç”¨ `handleEvent()`ã€‚

#### â–¶ å†…éƒ¨åˆ†å‘é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
```cpp
void Channel::handleEvent(Timestamp receiveTime) {
  if (revents_ & EPOLLIN || revents_ & EPOLLPRI) {
    if (readCallback_) readCallback_(receiveTime);
  }
  if (revents_ & EPOLLOUT) {
    if (writeCallback_) writeCallback_();
  }
  if (revents_ & EPOLLERR) {
    if (errorCallback_) errorCallback_();
  }
  if (revents_ & EPOLLHUP && !(revents_ & EPOLLIN)) {
    if (closeCallback_) closeCallback_();
  }
}
```

> âœ… **å…³é”®ç‚¹**ï¼š
> - å…ˆæ£€æŸ¥ `EPOLLIN`/`EPOLLPRI`ï¼ˆå¸¦å¤–æ•°æ®ï¼‰â†’ è°ƒç”¨ `readCallback_`ï¼›
> - å†æ£€æŸ¥ `EPOLLOUT` â†’ è°ƒç”¨ `writeCallback_`ï¼›
> - `EPOLLHUP`ï¼ˆå¯¹ç«¯å…³é—­ï¼‰é€šå¸¸ä¼´éš `EPOLLIN`ï¼ˆè¯»åˆ° EOFï¼‰ï¼Œæ‰€ä»¥åªæœ‰å½“**æ²¡æœ‰å¯è¯»æ•°æ®**æ—¶æ‰è§†ä¸ºè¿æ¥å…³é—­ï¼›
> - æ‰€æœ‰å›è°ƒå‡ä¸º `std::function`ï¼Œç”±ä¸Šå±‚ï¼ˆå¦‚ `TcpConnection`ï¼‰æ³¨å†Œã€‚

---

## äºŒã€EpollPoller å®ç°ç»†èŠ‚

### 1. å¦‚ä½•åŒºåˆ† `EPOLL_CTL_ADD` ä¸ `EPOLL_CTL_MOD`ï¼Ÿ

#### â–¶ æ ¸å¿ƒæœºåˆ¶ï¼šåˆ©ç”¨ `Channel::index_`
- `Channel` æœ‰ä¸€ä¸ªæˆå‘˜ `int index_`ï¼Œç”¨äºæ ‡è®°å…¶åœ¨ `Poller` ä¸­çš„çŠ¶æ€ï¼š
  - `index_ == kNew`ï¼ˆ-1ï¼‰ï¼šå°šæœªåŠ å…¥ epollï¼›
  - `index_ == kAdded`ï¼ˆ1ï¼‰ï¼šå·²åœ¨ epoll ä¸­ï¼›
  - `index_ == kDeleted`ï¼ˆ2ï¼‰ï¼šå·²ä» epoll åˆ é™¤ï¼ˆä½†å¯¹è±¡æœªææ„ï¼‰ã€‚

#### â–¶ `EpollPoller::updateChannel()` é€»è¾‘ï¼š
```cpp
void EpollPoller::updateChannel(Channel* channel) {
  assertInLoopThread();
  const int index = channel->index();
  const int fd = channel->fd();

  if (index == kNew || index == kDeleted) {
    // ADD: æ–°é€šé“ or å·²åˆ é™¤çš„é€šé“é‡æ–°å¯ç”¨
    if (index == kNew) {
      channels_[fd] = channel; // åŠ å…¥ map
    } else {
      // kDeleted â†’ é‡æ–°æ¿€æ´»
    }
    channel->setIndex(kAdded);
    update(EPOLL_CTL_ADD, channel); // â† æ‰§è¡Œ ADD
  } else {
    // MOD: å·²åœ¨ epoll ä¸­ï¼Œåªéœ€æ›´æ–°äº‹ä»¶
    update(EPOLL_CTL_MOD, channel); // â† æ‰§è¡Œ MOD
  }
}
```

> âœ… **ä¼˜åŠ¿**ï¼šé¿å…é‡å¤ `ADD` å¯¼è‡´ `EEXIST` é”™è¯¯ï¼Œä¹Ÿé¿å…å¯¹ä¸å­˜åœ¨çš„ fd æ‰§è¡Œ `MOD`ã€‚

---

### 2. `EpollPoller::fillActiveChannels()` çš„ç›®çš„ä¸å¿…è¦æ€§

#### â–¶ ç›®çš„ï¼š
å°† `epoll_wait()` è¿”å›çš„åŸå§‹ `epoll_event` æ•°ç»„ï¼Œ**è½¬æ¢ä¸º `Channel*` æŒ‡é’ˆåˆ—è¡¨**ï¼Œä¾› `EventLoop` åˆ†å‘ã€‚

#### â–¶ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
- `epoll_wait()` è¿”å›çš„æ˜¯ `struct epoll_event events[MAX_EVENTS]`ï¼Œå…¶ä¸­ `data.fd` æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼›
- ä½† `EventLoop` éœ€è¦çŸ¥é“ **å“ªä¸ª `Channel` å¯¹åº”è¿™ä¸ª fd**ï¼Œæ‰èƒ½è°ƒç”¨å…¶å›è°ƒï¼›
- `EpollPoller` å†…éƒ¨ç»´æŠ¤äº† `std::unordered_map<int, Channel*> channels_`ï¼Œå®ç° **fd â†’ Channel* æ˜ å°„**ã€‚

#### â–¶ å®ç°é€»è¾‘ï¼š
```cpp
void EpollPoller::fillActiveChannels(int numEvents,
                                    ChannelList* activeChannels) const {
  for (int i = 0; i < numEvents; ++i) {
    Channel* channel = channels_.at(events_[i].data.fd);
    channel->setRevents(events_[i].events); // â† è®¾ç½® revents_
    activeChannels->push_back(channel);
  }
}
```

> âœ… **å…³é”®ä½œç”¨**ï¼š
> - å®Œæˆ **fd â†’ Channel*** çš„æŸ¥æ‰¾ï¼›
> - **è®¾ç½® `revents_`**ï¼Œä¸ºåç»­ `handleEvent()` æä¾›ä¾æ®ï¼›
> - æ„å»º `activeChannels_` åˆ—è¡¨ï¼Œä¾› `EventLoop` éå†ã€‚

---

## æ€»ç»“å›ç­”ï¼ˆé¢è¯•å£è¯­åŒ–ç²¾ç®€ç‰ˆï¼‰

> â€œ`Channel` å°è£…ä¸€ä¸ª fd å’Œå®ƒçš„äº‹ä»¶å›è°ƒï¼Œ`Poller`ï¼ˆå¦‚ `EpollPoller`ï¼‰ç®¡ç†å¤šä¸ª `Channel` å¹¶ä¸ epoll äº¤äº’ï¼Œ`EventLoop` é©±åŠ¨æ•´ä¸ªæµç¨‹ï¼šå®ƒè°ƒç”¨ `Poller::poll()` è·å–å°±ç»ªçš„ `Channel` åˆ—è¡¨ï¼Œç„¶åé€ä¸ªè°ƒç”¨ `Channel::handleEvent()`ã€‚
>
> `events_` æ˜¯ç”¨æˆ·æƒ³ç›‘å¬çš„äº‹ä»¶ï¼ˆå¦‚ `EPOLLIN`ï¼‰ï¼Œç”± `enableReading()` è®¾ç½®ï¼›`revents_` æ˜¯å†…æ ¸è¿”å›çš„å®é™…å°±ç»ªäº‹ä»¶ï¼Œç”± `Poller::poll()` åœ¨ `fillActiveChannels` ä¸­è®¾ç½®ã€‚
>
> `handleEvent()` ç”± `EventLoop` è°ƒç”¨ï¼Œå®ƒæ ¹æ® `revents_` çš„å€¼åˆ†å‘åˆ° `readCallback_`ã€`writeCallback_` ç­‰ã€‚
>
> åœ¨ `EpollPoller::updateChannel()` ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `Channel::index_` åŒºåˆ†æ˜¯ `ADD` è¿˜æ˜¯ `MOD`ï¼šæ–°é€šé“æˆ–å·²åˆ é™¤çš„é€šé“ç”¨ `ADD`ï¼Œå·²åœ¨ epoll ä¸­çš„ç”¨ `MOD`ã€‚
>
> `fillActiveChannels()` çš„ä½œç”¨æ˜¯æŠŠ `epoll_wait` è¿”å›çš„ fd åˆ—è¡¨è½¬æ¢æˆ `Channel*` åˆ—è¡¨ï¼Œå¹¶è®¾ç½®æ¯ä¸ª `Channel` çš„ `revents_`ï¼Œè¿™æ˜¯äº‹ä»¶åˆ†å‘çš„å…³é”®æ¡¥æ¢ã€‚â€

---

å¦‚æœä½ å¸Œæœ›æˆ‘æä¾›ä»¥ä¸‹å†…å®¹ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼š
- `Channel::index_` çš„çŠ¶æ€æœºå›¾ï¼›
- `EpollPoller::update()` çš„å®Œæ•´å°è£…ï¼ˆå« `epoll_ctl` è°ƒç”¨ï¼‰ï¼›
- `handleEvent()` ä¸­å¯¹ `EPOLLHUP` å’Œ `EPOLLERR` çš„è¯¦ç»†å¤„ç†é€»è¾‘ã€‚

