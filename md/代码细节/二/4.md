

## ä¸€ã€å†…å­˜ç®¡ç†æœºåˆ¶

### 1. Buffer å†…éƒ¨å†…å­˜ç»„ç»‡ä¸ä¼˜åŠ¿

#### â–¶ å†…å­˜å¸ƒå±€ï¼ˆä¸‰æ®µå¼ï¼‰
`Buffer` å†…éƒ¨ä½¿ç”¨ä¸€ä¸ª `std::vector<char> buffer_`ï¼Œå¹¶é€šè¿‡ä¸¤ä¸ªç´¢å¼•åˆ’åˆ†é€»è¾‘åŒºåŸŸï¼š

```
+-------------------+------------------+------------------+
| prependable bytes | readable bytes   | writable bytes   |
+-------------------+------------------+------------------+
^                   ^                  ^                  ^
0              readerIndex_      writerIndex_       buffer_.size()
```

- **`prependable` åŒºåŸŸ**ï¼š`[0, readerIndex_)`ï¼Œå·²æ¶ˆè´¹æ•°æ®ï¼Œå¯å¤ç”¨ï¼›
- **`readable` åŒºåŸŸ**ï¼š`[readerIndex_, writerIndex_)`ï¼Œæœ‰æ•ˆæ•°æ®ï¼›
- **`writable` åŒºåŸŸ**ï¼š`[writerIndex_, buffer_.size())`ï¼Œå¯å†™å…¥ç©ºé—´ã€‚

#### â–¶ ç›¸æ¯”ç®€å• `vector<char>` çš„ä¼˜åŠ¿ï¼š
| é—®é¢˜ | ç®€å• `vector` | `muduo::Buffer` |
|------|--------------|----------------|
| **è¯»å–åç§»é™¤æ•°æ®** | éœ€ `erase(begin, pos)`ï¼ŒO(n) æ¬ç§» | ä»…ç§»åŠ¨ `readerIndex_`ï¼ŒO(1) |
| **åœ¨å¤´éƒ¨æ·»åŠ æ•°æ®**ï¼ˆå¦‚åè®®å¤´ï¼‰ | éœ€ `insert(begin, ...)`ï¼ŒO(n) | åˆ©ç”¨ `prependable` ç©ºé—´ï¼ŒO(1) |
| **é¿å…é¢‘ç¹ realloc** | æ¯æ¬¡ `resize` å¯èƒ½æ‹·è´å…¨éƒ¨æ•°æ® | é€šè¿‡ `makeSpace` å¤ç”¨å‰éƒ¨ç©ºé—´ |

> âœ… **æ ¸å¿ƒæ€æƒ³**ï¼š**ç”¨ç´¢å¼•ä»£æ›¿å†…å­˜æ¬ç§»**ï¼Œæå¤§æå‡é«˜é¢‘ I/O åœºæ™¯æ€§èƒ½ã€‚

---

### 2. `append` ä¸ `makeSpace` / `shrink` æœºåˆ¶

#### â–¶ `append` æµç¨‹ï¼š
```cpp
void Buffer::append(const char* data, size_t len) {
  ensureWritableBytes(len); // â† ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
  std::copy(data, data + len, beginWrite());
  writerIndex_ += len;
}
```

#### â–¶ `makeSpace(size_t len)` è¡Œä¸ºï¼š
å½“ `writableBytes() < len` æ—¶ï¼š
1. **å…ˆå°è¯•å¤ç”¨ prependable ç©ºé—´**ï¼š
   - è‹¥ `prependableBytes() + writableBytes() >= len` â†’ **ä¸é‡æ–°åˆ†é…**ï¼
   - å°† readable æ•°æ® **å‰ç§»** åˆ° buffer èµ·å§‹ä½ç½®ï¼›
   - æ›´æ–° `readerIndex_ = 0`, `writerIndex_ = readableBytes()`ï¼›
2. **å¦åˆ™æ‰æ‰©å®¹**ï¼š
   - `buffer_.resize(writerIndex_ + len)`ï¼ˆé€šå¸¸æŒ‰å€æ•°å¢é•¿ï¼‰ã€‚

> ğŸ” **å…³é”®ä¼˜åŒ–**ï¼šå¤šæ•°æƒ…å†µä¸‹ï¼Œ`makeSpace` **ä¸ä¼šè§¦å‘ realloc**ï¼Œè€Œæ˜¯é€šè¿‡ç§»åŠ¨æ•°æ®å¤ç”¨å‰éƒ¨ç©ºé—´ã€‚

#### â–¶ `shrink()` çš„ä½œç”¨ä¸è°ƒç”¨æ—¶æœºï¼š
- **ä½œç”¨**ï¼šé‡Šæ”¾å¤šä½™å†…å­˜ï¼Œå°† `buffer_.size()` ç¼©å°åˆ° `kCheapPrepend + readableBytes()`ï¼›
- **è°ƒç”¨æ—¶æœº**ï¼š
  - ç”¨æˆ·æ˜¾å¼è°ƒç”¨ï¼ˆå¦‚é•¿æ—¶é—´ç©ºé—²åï¼‰ï¼›
  - åœ¨æŸäº›å®ç°ä¸­ï¼Œå½“ `readableBytes()` è¿œå°äºå®¹é‡æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆä½† muduo é»˜è®¤ä¸è‡ªåŠ¨ shrinkï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰ï¼›
- **ç›®çš„**ï¼šé˜²æ­¢å†…å­˜é•¿æœŸå ç”¨è¿‡å¤§ï¼ˆå¦‚çªå‘æµé‡åï¼‰ã€‚

---

### 3. `retrieve` ç³»åˆ—å‡½æ•°çš„è¡Œä¸ºä¸å†…å­˜é‡Šæ”¾

#### â–¶ å¸¸è§æ¥å£ï¼š
- `retrieve(size_t len)`ï¼šè·³è¿‡ `len` å­—èŠ‚ï¼›
- `retrieveUntil(const char* end)`ï¼šè·³è¿‡ç›´åˆ° `end` æŒ‡é’ˆï¼›
- `retrieveAll()`ï¼šæ¸…ç©ºæ‰€æœ‰ readable æ•°æ®ã€‚

#### â–¶ æ˜¯å¦é‡Šæ”¾å†…å­˜ï¼Ÿ
- **å¦ï¼** å®ƒä»¬åªç§»åŠ¨ `readerIndex_`ï¼Œ**ä¸è°ƒç”¨ `vector::shrink_to_fit()`**ï¼›
- **åŸå› **ï¼š
  1. **æ€§èƒ½ä¼˜å…ˆ**ï¼šé¢‘ç¹ realloc ä»£ä»·é«˜ï¼›
  2. **ç©ºé—´å¤ç”¨**ï¼šprependable ç©ºé—´å¯è¢«åç»­ `append` æˆ– `prepend` å¤ç”¨ï¼›
  3. **å¯æ§é‡Šæ”¾**ï¼šç”±ç”¨æˆ·å†³å®šä½•æ—¶è°ƒç”¨ `shrink()`ã€‚

> âœ… **è®¾è®¡å“²å­¦**ï¼š**â€œæ‡’é‡Šæ”¾â€ + â€œç©ºé—´å¤ç”¨â€**ï¼Œå¹³è¡¡å†…å­˜ä¸æ€§èƒ½ã€‚

---

## äºŒã€åº”ç”¨åè®®å¤„ç†ï¼šè¡Œåè®®ï¼ˆ`\r\n` ç»“å°¾ï¼‰

### å¦‚ä½•ç”¨ `findCRLF()` å’Œ `retrieveUntil()` è¯»å–ä¸€è¡Œï¼Ÿ

#### â–¶ æ­¥éª¤ï¼š
1. **æŸ¥æ‰¾ CRLF ä½ç½®**ï¼š
   ```cpp
   const char* crlf = buffer.findCRLF();
   if (crlf != nullptr) {
     // æ‰¾åˆ°å®Œæ•´ä¸€è¡Œ
   }
   ```
2. **æå–è¡Œå†…å®¹ï¼ˆä¸å« `\r\n`ï¼‰**ï¼š
   ```cpp
   std::string line(buffer.peek(), crlf);
   ```
3. **æ¶ˆè´¹è¯¥è¡Œï¼ˆåŒ…æ‹¬ `\r\n`ï¼‰**ï¼š
   ```cpp
   buffer.retrieveUntil(crlf + 2); // +2 è·³è¿‡ \r\n
   ```

#### â–¶ å®Œæ•´ç¤ºä¾‹ï¼ˆåœ¨ `messageCallback_` ä¸­ï¼‰ï¼š
```cpp
void onMessage(const TcpConnectionPtr& conn, Buffer* buffer, Timestamp) {
  const char* crlf = nullptr;
  while ((crlf = buffer->findCRLF()) != nullptr) {
    std::string line(buffer->peek(), crlf);
    // å¤„ç† line
    processLine(line);

    // æ¶ˆè´¹æ•´è¡Œï¼ˆå« \r\nï¼‰
    buffer->retrieveUntil(crlf + 2);
  }
  // æœªæ‰¾åˆ° CRLF â†’ åŠåŒ…ï¼Œç­‰å¾…æ›´å¤šæ•°æ®
}
```

#### â–¶ è¾¹ç•Œæƒ…å†µå¤„ç†ï¼š
- **åŠåŒ…**ï¼š`findCRLF()` è¿”å› `nullptr` â†’ ä¿ç•™æ•°æ®åœ¨ bufferï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¯»å–ï¼›
- **ç²˜åŒ…**ï¼šwhile å¾ªç¯å¤„ç†æ‰€æœ‰å®Œæ•´è¡Œï¼›
- **è¶…é•¿è¡Œ**ï¼šå¯åŠ é•¿åº¦æ£€æŸ¥ï¼Œé˜² DoSã€‚

> âœ… **ä¼˜åŠ¿**ï¼šæ— éœ€é¢å¤–æ‹·è´ï¼Œç›´æ¥æ“ä½œ buffer å†…å­˜ï¼›é«˜æ•ˆå¤„ç†ç²˜åŒ…/åŠåŒ…ã€‚

---

## æ€»ç»“å›ç­”ï¼ˆé¢è¯•å£è¯­åŒ–ç²¾ç®€ç‰ˆï¼‰

> â€œæˆ‘ä»¬çš„ `Buffer` ä½¿ç”¨ä¸‰æ®µå¼å†…å­˜å¸ƒå±€ï¼šprependableã€readableã€writableï¼Œé€šè¿‡ `readerIndex_` å’Œ `writerIndex_` ç®¡ç†ã€‚ç›¸æ¯”ç®€å• vectorï¼Œå®ƒé¿å…äº†è¯»å–å O(n) æ¬ç§»ï¼Œä¸”æ”¯æŒ O(1) å¤´éƒ¨æ’å…¥ã€‚
>
> `append` æ—¶è‹¥ç©ºé—´ä¸è¶³ï¼Œ`makeSpace` ä¼šå…ˆå°è¯•å°† readable æ•°æ®å‰ç§»å¤ç”¨ prependable ç©ºé—´ï¼Œåªæœ‰å®åœ¨ä¸å¤Ÿæ‰ reallocã€‚`shrink` ç”¨äºæ‰‹åŠ¨é‡Šæ”¾å¤šä½™å†…å­˜ï¼Œé€šå¸¸åœ¨è¿æ¥ç©ºé—²æ—¶è°ƒç”¨ã€‚
>
> `retrieve` ç³»åˆ—å‡½æ•°åªç§»åŠ¨ `readerIndex_`ï¼Œä¸é‡Šæ”¾å†…å­˜â€”â€”è¿™æ˜¯ä¸ºäº†å¤ç”¨ prependable ç©ºé—´ï¼Œæå‡æ€§èƒ½ã€‚
>
> å¯¹äºè¡Œåè®®ï¼Œæˆ‘ä»¬ç”¨ `findCRLF()` æŸ¥æ‰¾ `\r\n`ï¼Œç”¨ `peek()` è·å–è¡Œå†…å®¹ï¼Œå†ç”¨ `retrieveUntil(crlf + 2)` æ¶ˆè´¹æ•´è¡Œã€‚è¿™æ ·èƒ½é«˜æ•ˆå¤„ç†ç²˜åŒ…å’ŒåŠåŒ…ï¼Œä¸”é›¶æ‹·è´ã€‚â€

