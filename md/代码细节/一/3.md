

### 1. å¤šè·¯å¤ç”¨å™¨çš„å¯æ’æ‹”è®¾è®¡åŸç†

#### â–¶ æ ¸å¿ƒæ€æƒ³ï¼š**é¢å‘æ¥å£ç¼–ç¨‹ + å·¥å‚æ–¹æ³•**
`re_muduo` é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç° `poll`/`epoll` ç­‰ I/O å¤šè·¯å¤ç”¨æœºåˆ¶çš„å¯æ’æ‹”ï¼š

| å±‚çº§ | ç»„ä»¶ | ä½œç”¨ |
|------|------|------|
| **æŠ½è±¡å±‚** | `Poller.h` | å®šä¹‰ç»Ÿä¸€æ¥å£ï¼ˆçº¯è™šç±»ï¼‰ï¼Œå£°æ˜ `poll()`, `updateChannel()`, `removeChannel()` ç­‰ |
| **å®ç°å±‚** | `EpollPoller.h/cpp`<br>`PollPoller.h/cpp`ï¼ˆè™½æœªåœ¨ä½ é¡¹ç›®ä¸­å‡ºç°ï¼Œä½†è®¾è®¡ä¸Šæ”¯æŒï¼‰ | å…·ä½“å®ç°ä¸åŒåç«¯ï¼ˆå¦‚ `epoll` ä½¿ç”¨ `epoll_ctl`/`epoll_wait`ï¼‰ |
| **åˆ›å»ºå±‚** | `DefaultPoller.cpp` | æä¾›å·¥å‚å‡½æ•°ï¼Œæ ¹æ®ç¼–è¯‘æ—¶æˆ–è¿è¡Œæ—¶ç­–ç•¥è¿”å›å…·ä½“ `Poller` å®ä¾‹ |

> âœ… è¿™ç§è®¾è®¡ä½¿å¾— `EventLoop` **å®Œå…¨ä¸ä¾èµ–å…·ä½“å®ç°**ï¼ŒåªæŒæœ‰ `Poller*`ï¼ˆæˆ– `std::unique_ptr<Poller>`ï¼‰ï¼Œä»è€Œå®ç°â€œä¾èµ–å€’ç½®â€ã€‚

#### â–¶ `Poller` æ¥å£å…³é”®æ–¹æ³•ï¼ˆ`Poller.h`ï¼‰
```cpp
class Poller : noncopyable {
public:
    using ChannelList = std::vector<Channel*>;

    virtual ~Poller() = default;
    virtual Timestamp poll(int timeoutMs, ChannelList* activeChannels) = 0;
    virtual void updateChannel(Channel* channel) = 0;
    virtual void removeChannel(Channel* channel) = 0;

    // å¯é€‰ï¼šç”¨äºè°ƒè¯•æˆ–æ—¥å¿—
    virtual bool hasChannel(Channel* channel) const = 0;

    // å·¥å‚æ–¹æ³•ï¼ˆé€šå¸¸æ”¾åœ¨ .cpp ä¸­ï¼‰
    static Poller* newDefaultPoller(EventLoop* loop);
};
```

#### â–¶ `EpollPoller` å®ç°è¦ç‚¹ï¼ˆ`EpollPoller.cpp`ï¼‰
- å†…éƒ¨ç»´æŠ¤ `epoll_fd_` å’Œ `channels_`ï¼ˆ`std::unordered_map<int, Channel*>`ï¼‰ï¼›
- `updateChannel()` æ ¹æ® `Channel::index()` åˆ¤æ–­æ˜¯ `EPOLL_CTL_ADD` è¿˜æ˜¯ `EPOLL_CTL_MOD`ï¼›
- `poll()` è°ƒç”¨ `::epoll_wait()`ï¼Œå¡«å…… `activeChannels`ã€‚

---

### 2. `DefaultPoller.cpp` çš„å…·ä½“ä½œç”¨

`DefaultPoller.cpp` æ˜¯**å·¥å‚å®ç°æ–‡ä»¶**ï¼Œå…¶æ ¸å¿ƒèŒè´£æ˜¯ï¼š

> **æ ¹æ®é¢„å®šä¹‰ç­–ç•¥ï¼Œåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªé»˜è®¤çš„ `Poller` å®ä¾‹ï¼ˆé€šå¸¸æ˜¯ `EpollPoller`ï¼‰**ã€‚

#### â–¶ å…¸å‹å®ç°ï¼ˆåŸºäºä½ çš„é¡¹ç›®ç»“æ„ï¼‰
```cpp
// DefaultPoller.cpp
#include "Poller.h"
#include "EpollPoller.h"

Poller* Poller::newDefaultPoller(EventLoop* loop) {
#ifdef USE_POLL
    return new PollPoller(loop);
#else
    return new EpollPoller(loop);  // é»˜è®¤ä½¿ç”¨ epoll
#endif
}
```

> ğŸ” åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œç”±äºåªçœ‹åˆ° `EpollPoller.*` å’Œ `DefaultPoller.cpp`ï¼Œä¸”æ—  `PollPoller`ï¼Œå¯æ¨æ–­ï¼š
> - å½“å‰ä»…å®ç°äº† `epoll` åç«¯ï¼›
> - `DefaultPoller.cpp` ç›´æ¥è¿”å› `new EpollPoller(loop)`ï¼›
> - ä½†**ä¿ç•™äº†æ‰©å±•æ¥å£**ï¼Œæœªæ¥åªéœ€æ·»åŠ  `PollPoller` å¹¶ä¿®æ”¹æ­¤æ–‡ä»¶å³å¯æ”¯æŒ `poll`ã€‚

#### â–¶ ä¸ºä»€ä¹ˆéœ€è¦å•ç‹¬çš„ `DefaultPoller.cpp`ï¼Ÿ
1. **é¿å…å¤´æ–‡ä»¶æ±¡æŸ“**  
   - `Poller.h` ä¸éœ€è¦åŒ…å« `EpollPoller.h`ï¼Œä¿æŒæ¥å£å¹²å‡€ï¼›
   - ç”¨æˆ·åªéœ€ `#include "Poller.h"` å³å¯ä½¿ç”¨å·¥å‚æ–¹æ³•ã€‚

2. **ç¼–è¯‘æ—¶è§£è€¦**  
   - `EventLoop.cpp` åªä¾èµ– `Poller.h`ï¼Œä¸ä¾èµ–å…·ä½“å®ç°ï¼›
   - é“¾æ¥æ—¶æ‰ç»‘å®š `EpollPoller.o`ï¼Œä¾¿äºæ›¿æ¢ã€‚

3. **æ”¯æŒè¿è¡Œæ—¶/ç¼–è¯‘æ—¶ç­–ç•¥åˆ‡æ¢**  
   - å¯é€šè¿‡å®ï¼ˆå¦‚ `USE_EPOLL` / `USE_POLL`ï¼‰æˆ–é…ç½®é€‰æ‹©åç«¯ï¼›
   - ç”šè‡³å¯æ‰©å±•ä¸ºè¿è¡Œæ—¶æ£€æµ‹ï¼ˆå¦‚æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼‰ã€‚

---

### 3. `EventLoop` å¦‚ä½•ä½¿ç”¨è¿™ä¸ªè®¾è®¡ï¼Ÿ

åœ¨ `EventLoop` æ„é€ å‡½æ•°ä¸­ï¼š
```cpp
// EventLoop.cpp
EventLoop::EventLoop()
  : poller_(Poller::newDefaultPoller(this))  // â† å…³é”®ï¼šé€šè¿‡å·¥å‚åˆ›å»º
{
  // ...
}
```

> âœ… è¿™æ ·ï¼Œ`EventLoop` å¯¹ `epoll` æˆ– `poll` **å®Œå…¨æ— æ„ŸçŸ¥**ï¼Œå®ç°äº†â€œé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—â€ã€‚

---

### æ€»ç»“å›ç­”ï¼ˆé¢è¯•å£è¯­åŒ–ç²¾ç®€ç‰ˆï¼‰

> â€œåœ¨ re_muduo ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æŠ½è±¡åŸºç±» `Poller` å®šä¹‰äº†ç»Ÿä¸€çš„ I/O å¤šè·¯å¤ç”¨æ¥å£ï¼Œè€Œ `EpollPoller` æ˜¯å…¶åŸºäº `epoll` çš„å…·ä½“å®ç°ã€‚`DefaultPoller.cpp` çš„ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªå·¥å‚å‡½æ•° `Poller::newDefaultPoller()`ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶å†³å®šè¿”å›å“ªç§ `Poller` å®ä¾‹â€”â€”å½“å‰é¡¹ç›®é»˜è®¤è¿”å› `EpollPoller`ã€‚
>
> è¿™ç§è®¾è®¡è®© `EventLoop` åªä¾èµ– `Poller` æ¥å£ï¼Œè€Œä¸å…³å¿ƒåº•å±‚æ˜¯ `epoll` è¿˜æ˜¯ `poll`ï¼Œå®ç°äº†å¯æ’æ‹”ã€‚æœªæ¥è‹¥è¦æ”¯æŒå…¶ä»–æœºåˆ¶ï¼ˆå¦‚ `kqueue` æˆ– `io_uring`ï¼‰ï¼Œåªéœ€æ–°å¢å®ç°ç±»å¹¶ä¿®æ”¹å·¥å‚å‡½æ•°ï¼Œæ— éœ€æ”¹åŠ¨æ ¸å¿ƒäº‹ä»¶å¾ªç¯é€»è¾‘ã€‚â€

