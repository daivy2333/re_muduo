### 1. æ ¸å¿ƒæ¨¡å—åŠå…¶èŒè´£

åœ¨ `re_muduo` é¡¹ç›®ä¸­ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†ä¸€ä¸ªåŸºäº **Reactor æ¨¡å¼** çš„é«˜æ€§èƒ½äº‹ä»¶é©±åŠ¨ç½‘ç»œåº“ï¼š

| æ¨¡å— | èŒè´£è¯´æ˜ |
|------|--------|
| **`EventLoop`** | äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒã€‚æ¯ä¸ªçº¿ç¨‹æœ€å¤šæ‹¥æœ‰ä¸€ä¸ª `EventLoop`ï¼Œè´Ÿè´£ï¼š<br>â€¢ è°ƒç”¨ `Poller::poll()` ç­‰å¾… I/O äº‹ä»¶<br>â€¢ åˆ†å‘å°±ç»ªçš„ `Channel` å›è°ƒï¼ˆread/write/close/errorï¼‰<br>â€¢ æ‰§è¡Œè·¨çº¿ç¨‹ä»»åŠ¡ï¼ˆé€šè¿‡ `queueInLoop` å’Œ `runInLoop`ï¼‰<br>â€¢ ç®¡ç†å®šæ—¶å™¨ï¼ˆè™½æœªæ˜¾å¼å®ç°ï¼Œä½†å¯æ‰©å±•ï¼‰ |
| **`Channel`** | å°è£…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰åŠå…¶å…³æ³¨çš„äº‹ä»¶ï¼ˆ`EPOLLIN`, `EPOLLOUT` ç­‰ï¼‰å’Œå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚<br>â€¢ ä¸æ‹¥æœ‰ fd ç”Ÿå‘½å‘¨æœŸï¼Œåªè´Ÿè´£äº‹ä»¶æ³¨å†Œ/æ³¨é”€å’Œåˆ†å‘<br>â€¢ æ˜¯ `EventLoop` ä¸åº•å±‚ `Poller` ä¹‹é—´çš„æ¡¥æ¢ |
| **`Poller` / `EpollPoller`** | I/O å¤šè·¯å¤ç”¨æŠ½è±¡ã€‚`Poller` æ˜¯æ¥å£ï¼Œ`EpollPoller` æ˜¯åŸºäº `epoll` çš„å…·ä½“å®ç°ã€‚<br>â€¢ ç»´æŠ¤ fd åˆ° `Channel*` çš„æ˜ å°„ï¼ˆ`std::unordered_map<int, Channel*>`ï¼‰<br>â€¢ æä¾› `poll()`ã€`updateChannel()`ã€`removeChannel()` æ¥å£ |
| **`TcpConnection`** | è¡¨ç¤ºä¸€æ¡ TCP è¿æ¥ã€‚<br>â€¢ æ‹¥æœ‰ä¸€ä¸ª `Socket`ï¼ˆç®¡ç†è¿æ¥ socketï¼‰å’Œä¸€ä¸ª `Channel`ï¼ˆç›‘å¬è¯¥ socketï¼‰<br>â€¢ ç®¡ç†è¿æ¥çŠ¶æ€ï¼ˆ`kConnected`, `kDisconnecting`, `kDisconnected`ï¼‰<br>â€¢ æä¾› `send()`ã€`shutdown()` ç­‰æ¥å£ï¼Œå¹¶é€šè¿‡ `Buffer` å¤„ç†æ”¶å‘æ•°æ®<br>â€¢ æ”¯æŒé«˜æ°´ä½å›è°ƒï¼ˆæµé‡æ§åˆ¶ï¼‰ |
| **`Buffer`** | åº”ç”¨å±‚è¯»å†™ç¼“å†²åŒºï¼Œè§£å†³**ç²˜åŒ…/åŠåŒ…**é—®é¢˜ã€‚<br>â€¢ å†…éƒ¨ä½¿ç”¨ `std::vector<char>` å­˜å‚¨ï¼Œç»´æŠ¤ `readerIndex_` å’Œ `writerIndex_`<br>â€¢ æä¾› `readableBytes()`, `writableBytes()`, `prependableBytes()`<br>â€¢ æ”¯æŒè‡ªåŠ¨æ‰©å®¹ï¼ˆ`makeSpace`ï¼‰å’Œæ”¶ç¼©ï¼ˆ`shrink`ï¼‰ |
| **`Acceptor`** | ç›‘å¬ socket çš„å°è£…ã€‚<br>â€¢ åˆ›å»º listen fdï¼Œç»‘å®šåœ°å€ï¼Œå¼€å¯ç›‘å¬<br>â€¢ æ³¨å†Œ `accept` äº‹ä»¶åˆ° `EventLoop`<br>â€¢ æ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œå›è°ƒ `newConnectionCallback_`ï¼Œä¼ é€’æ–°è¿æ¥çš„ socket fd |
| **`TcpServer`** | æœåŠ¡å™¨ä¸»å…¥å£ã€‚<br>â€¢ æ‹¥æœ‰ `Acceptor`<br>â€¢ ç®¡ç†æ‰€æœ‰ `TcpConnection`ï¼ˆ`std::unordered_map<string, TcpConnectionPtr>`ï¼‰<br>â€¢ ä½¿ç”¨ `EventLoopThreadPool` å®ç°å¤š Reactorï¼ˆone loop per threadï¼‰æ¨¡å‹ |
| **`EventLoopThreadPool`** | çº¿ç¨‹æ± ï¼Œç”¨äºåˆ†é… `EventLoop` ç»™æ–°è¿æ¥ã€‚<br>â€¢ å¯åŠ¨è‹¥å¹² `EventLoopThread`ï¼Œæ¯ä¸ªçº¿ç¨‹è¿è¡Œä¸€ä¸ª `EventLoop`<br>â€¢ æ”¯æŒè½®è¯¢æˆ–å“ˆå¸Œåˆ†é…ç­–ç•¥ |
| **`EventLoopThread`** | å°è£…ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹è¿è¡Œä¸€ä¸ª `EventLoop`ã€‚<br>â€¢ é€šè¿‡ `thread_` å¯åŠ¨ï¼Œé€šè¿‡ `mutex_` + `condition_variable_` åŒæ­¥è·å– `EventLoop*` |
| **`Socket` / `InetAddress`** | å°è£… socket API å’Œåœ°å€ä¿¡æ¯ã€‚<br>â€¢ `InetAddress`ï¼šå°è£… `sockaddr_in`ï¼Œæä¾› IP/Port çš„è§£æä¸æ„é€ <br>â€¢ `Socket`ï¼šå°è£… `socket()`, `bind()`, `listen()`, `accept()`, `setsockopt()` ç­‰ï¼Œæä¾› RAII å¼ socket ç®¡ç† |
| **`CurrentThread` / `Thread`** | çº¿ç¨‹ç®¡ç†ä¸ ID ç¼“å­˜ã€‚<br>â€¢ `CurrentThread::tid()` é«˜æ•ˆè·å–å½“å‰çº¿ç¨‹ IDï¼ˆé€šè¿‡ `__thread` ç¼“å­˜ï¼‰<br>â€¢ `Thread` å°è£… `std::thread`ï¼Œæ”¯æŒå‘½åå’Œå¯åŠ¨å›è°ƒ |
| **`Logger`** | æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«ï¼ˆINFO/WARN/ERRORï¼‰ï¼Œä¾¿äºè°ƒè¯• |

> âœ… **æ•´ä½“æ¶æ„**ï¼š`TcpServer` â†’ `Acceptor` â†’ `TcpConnection`ï¼ˆç”± `EventLoopThreadPool` åˆ†é… `EventLoop`ï¼‰â†’ `Channel` â†” `EpollPoller` â†” å†…æ ¸ epollã€‚

---

### 2. ä¸ºä»€ä¹ˆå°† Socketã€InetAddressã€Channelã€Poller ç­‰è®¾è®¡æˆç‹¬ç«‹ç±»ï¼Ÿå¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ **â€œå•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰â€** å’Œ **â€œå…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰â€** çš„å…¸å‹ä½“ç°ã€‚å…·ä½“å¥½å¤„å¦‚ä¸‹ï¼š

#### ï¼ˆ1ï¼‰**èŒè´£æ¸…æ™°ï¼Œé™ä½è€¦åˆ**
- `InetAddress` åªå…³å¿ƒåœ°å€è¡¨ç¤ºï¼ˆIP + Portï¼‰ï¼Œä¸æ¶‰åŠ socket æ“ä½œï¼›
- `Socket` åªå°è£…ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ `::socket`, `::bind`ï¼‰ï¼Œä¸å…³å¿ƒäº‹ä»¶ç›‘å¬ï¼›
- `Channel` åªå…³å¿ƒâ€œæŸä¸ª fd ä¸Šå‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶â€ï¼Œä¸å…³å¿ƒ fd æ˜¯è°åˆ›å»ºçš„ï¼›
- `Poller` åªå…³å¿ƒâ€œå¦‚ä½•é«˜æ•ˆç­‰å¾…å¤šä¸ª fd çš„äº‹ä»¶â€ï¼Œä¸å…³å¿ƒäº‹ä»¶å«ä¹‰ã€‚

> ğŸ” ä¸¾ä¾‹ï¼šè‹¥å°† `epoll_ctl` ç›´æ¥å†™åœ¨ `TcpConnection` é‡Œï¼Œä¼šå¯¼è‡´ç½‘ç»œé€»è¾‘ä¸ I/O å¤šè·¯å¤ç”¨é€»è¾‘å¼ºè€¦åˆï¼Œéš¾ä»¥æ›¿æ¢ä¸º `kqueue` æˆ– `select`ã€‚

#### ï¼ˆ2ï¼‰**å¯æµ‹è¯•æ€§ï¼ˆTestabilityï¼‰**
- æ¯ä¸ªç±»éƒ½å¯ä»¥ç‹¬ç«‹å•å…ƒæµ‹è¯•ï¼ˆå¦‚ä½ é¡¹ç›®ä¸­çš„ `test_socket.cpp`, `test_channel.cpp`ï¼‰ï¼›
- ä¾‹å¦‚ï¼š`test_acceptor.cpp` å¯ä»¥ mock `Socket` è¡Œä¸ºï¼Œæ— éœ€çœŸå®ç½‘ç»œã€‚

#### ï¼ˆ3ï¼‰**å¯å¤ç”¨æ€§ä¸æ‰©å±•æ€§**
- `Buffer` ä¸ä»…å¯ç”¨äº TCPï¼Œä¹Ÿå¯ç”¨äº UDP æˆ–æ–‡ä»¶ I/Oï¼›
- `EventLoop` + `Channel` + `Poller` æ¶æ„å¯è½»æ¾æ‰©å±•å®šæ—¶å™¨ã€ä¿¡å·å¤„ç†ç­‰ï¼›
- è‹¥æœªæ¥è¦æ”¯æŒ `io_uring`ï¼Œåªéœ€æ–°å¢ `IoUringPoller` ç»§æ‰¿ `Poller`ï¼Œå…¶ä»–æ¨¡å—å‡ ä¹ä¸åŠ¨ã€‚

#### ï¼ˆ4ï¼‰**ç¬¦åˆ RAII ä¸èµ„æºç®¡ç†åŸåˆ™**
- `Socket` åœ¨ææ„æ—¶è‡ªåŠ¨ `close(fd)`ï¼Œé¿å… fd æ³„æ¼ï¼›
- `Channel` çš„ç”Ÿå‘½å‘¨æœŸç”± `TcpConnection` æˆ– `Acceptor` ç®¡ç†ï¼Œç¡®ä¿äº‹ä»¶æ³¨é”€æ—¶æœºæ­£ç¡®ã€‚

---

### 3. `noncopyable.h` çš„ä½œç”¨ï¼Ÿå“ªäº›ç±»ç»§æ‰¿äº†å®ƒï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

#### â–¶ ä½œç”¨
`noncopyable` æ˜¯ä¸€ä¸ªç»å…¸çš„ C++ æƒ¯ç”¨æ³•ï¼ˆidiomï¼‰ï¼Œç”¨äº**ç¦æ­¢ç±»çš„æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ**ã€‚å…¶å…¸å‹å®ç°ä¸ºï¼š

```cpp
class noncopyable {
protected:
    noncopyable() = default;
    ~noncopyable() = default;

public:
    noncopyable(const noncopyable&) = delete;
    noncopyable& operator=(const noncopyable&) = delete;
};
```

#### â–¶ å“ªäº›ç±»ç»§æ‰¿äº†å®ƒï¼Ÿ
åœ¨ `re_muduo` ä¸­ï¼Œä»¥ä¸‹å…³é”®ç±»ç»§æ‰¿äº† `noncopyable`ï¼ˆæ ¹æ®ä¾èµ– `d33: include:[noncopyable.h]` å’Œå¸¸è§å®è·µï¼‰ï¼š
- `EventLoop`
- `Thread`
- `EventLoopThread`
- `EventLoopThreadPool`
- `Poller` / `EpollPoller`
- `Channel`
- `Socket`
- `Acceptor`
- `TcpConnection`
- `Buffer`ï¼ˆè™½ç„¶å¯ç§»åŠ¨ï¼Œä½†é€šå¸¸ä¹Ÿç¦ç”¨æ‹·è´ï¼‰

> ğŸ’¡ ä½ çš„é¡¹ç›®ä¸­å‡ ä¹æ‰€æœ‰**æŒæœ‰ç³»ç»Ÿèµ„æºï¼ˆfdã€çº¿ç¨‹ã€æŒ‡é’ˆï¼‰æˆ–å…·æœ‰å”¯ä¸€èº«ä»½ï¼ˆå¦‚ EventLoop ç»‘å®šç‰¹å®šçº¿ç¨‹ï¼‰** çš„ç±»éƒ½åº”ç»§æ‰¿ `noncopyable`ã€‚

#### â–¶ ä¸ºä»€ä¹ˆï¼Ÿ
1. **è¯­ä¹‰ä¸Šä¸å¯æ‹·è´**  
   - ä¸€ä¸ª `EventLoop` å¯¹è±¡ä»£è¡¨â€œå½“å‰çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯â€ï¼Œæ‹·è´å®ƒæ²¡æœ‰æ„ä¹‰ï¼›
   - ä¸€ä¸ª `Thread` å¯¹è±¡ä»£è¡¨â€œä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹â€ï¼Œä¸èƒ½è¢«å¤åˆ¶ï¼›
   - ä¸€ä¸ª `Socket` æŒæœ‰å”¯ä¸€çš„ `fd`ï¼Œæ‹·è´ä¼šå¯¼è‡´ double-closeã€‚

2. **é˜²æ­¢èµ„æºæ³„æ¼æˆ–åŒé‡é‡Šæ”¾**  
   - è‹¥å…è®¸æ‹·è´ `Socket`ï¼Œä¸¤ä¸ªå¯¹è±¡ä¼šæŒæœ‰åŒä¸€ä¸ª `fd`ï¼Œææ„æ—¶éƒ½ä¼š `close`ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚

3. **æ˜ç¡®è®¾è®¡æ„å›¾**  
   - é€šè¿‡ç»§æ‰¿ `noncopyable`ï¼Œå‘ä½¿ç”¨è€…æ¸…æ™°ä¼ è¾¾ï¼šâ€œè¿™ä¸ªç±»ä¸æ˜¯å€¼è¯­ä¹‰ï¼Œè€Œæ˜¯å¯¹è±¡è¯­ä¹‰ï¼ˆobject semanticsï¼‰â€ã€‚

> âœ… **ç°ä»£ C++ æ›¿ä»£æ–¹æ¡ˆ**ï¼šC++11 åå¯ç”¨ `= delete` ç›´æ¥ç¦ç”¨æ‹·è´ï¼Œä½† `noncopyable` ä½œä¸ºåŸºç±»ä»ç®€æ´ä¸”è‡ªæ–‡æ¡£åŒ–ã€‚

---

### æ€»ç»“å›ç­”ï¼ˆé¢è¯•å£è¯­åŒ–ç²¾ç®€ç‰ˆï¼‰

> â€œåœ¨ re_muduo ä¸­ï¼Œæˆ‘ä»¬æŒ‰ Reactor æ¨¡å¼åˆ’åˆ†ä¸ºå¤šä¸ªæ ¸å¿ƒæ¨¡å—ï¼š`EventLoop` è´Ÿè´£äº‹ä»¶å¾ªç¯ï¼Œ`Channel` å°è£… fd å’Œäº‹ä»¶å›è°ƒï¼Œ`Poller`ï¼ˆå¦‚ `EpollPoller`ï¼‰å®ç° I/O å¤šè·¯å¤ç”¨ï¼Œ`TcpConnection` ç®¡ç†å•æ¡è¿æ¥åŠæ”¶å‘ç¼“å†²ï¼ˆ`Buffer`ï¼‰ï¼Œ`Acceptor` å¤„ç†æ–°è¿æ¥ï¼Œ`TcpServer` ä½œä¸ºæ€»æ§å¹¶åˆ©ç”¨ `EventLoopThreadPool` å®ç°å¤šçº¿ç¨‹ã€‚
>
> å°† `Socket`ã€`InetAddress` ç­‰æ‹†åˆ†ä¸ºç‹¬ç«‹ç±»ï¼Œæ˜¯ä¸ºäº†éµå¾ªå•ä¸€èŒè´£åŸåˆ™â€”â€”æ¯”å¦‚ `InetAddress` åªç®¡åœ°å€è§£æï¼Œ`Socket` åªå°è£…ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·ä»£ç æ›´æ¸…æ™°ã€å¯æµ‹ã€å¯æ‰©å±•ï¼Œä¹Ÿä¾¿äºæœªæ¥æ›¿æ¢åº•å±‚æœºåˆ¶ï¼ˆå¦‚ä» epoll åˆ‡åˆ° io_uringï¼‰ã€‚
>
> è‡³äº `noncopyable`ï¼Œå®ƒç”¨äºç¦æ­¢æ‹·è´é‚£äº›æŒæœ‰ç³»ç»Ÿèµ„æºæˆ–å…·æœ‰å”¯ä¸€èº«ä»½çš„å¯¹è±¡ï¼Œæ¯”å¦‚ `EventLoop`ã€`Thread`ã€`Socket` ç­‰ã€‚å› ä¸ºæ‹·è´è¿™äº›å¯¹è±¡åœ¨è¯­ä¹‰ä¸Šæ— æ„ä¹‰ï¼Œä¸”ä¼šå¯¼è‡´èµ„æºç®¡ç†é”™è¯¯ï¼ˆå¦‚ double-closeï¼‰ã€‚æˆ‘ä»¬é€šè¿‡ç»§æ‰¿ `noncopyable` æ˜¾å¼è¡¨è¾¾è¿™ä¸€è®¾è®¡çº¦æŸã€‚â€

