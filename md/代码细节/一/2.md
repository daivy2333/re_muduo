
### 1. Reactor æ¨¡å¼è§£æåŠå…¶åœ¨ re_muduo ä¸­çš„æ˜ å°„

#### â–¶ Reactor æ¨¡å¼åŸºæœ¬æ¦‚å¿µ
Reactor æ˜¯ä¸€ç§**äº‹ä»¶é©±åŠ¨**çš„å¹¶å‘è®¾è®¡æ¨¡å¼ï¼Œç”¨äºé«˜æ•ˆå¤„ç†å¤šä¸ª I/O äº‹ä»¶ã€‚å…¶æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š

| ç»„ä»¶ | èŒè´£ |
|------|------|
| **Reactorï¼ˆååº”å™¨ï¼‰** | ä¸»äº‹ä»¶å¾ªç¯ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿå¹¶åˆ†å‘ |
| **Demultiplexerï¼ˆå¤šè·¯åˆ†è§£å™¨ï¼‰** | ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ `epoll_wait`ï¼‰ï¼Œé˜»å¡ç­‰å¾…å¤šä¸ª fd ä¸Šçš„äº‹ä»¶ï¼Œè¿”å›å°±ç»ªäº‹ä»¶åˆ—è¡¨ |
| **Dispatcherï¼ˆåˆ†å‘å™¨ï¼‰** | å°†å°±ç»ªäº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„ EventHandler |
| **EventHandlerï¼ˆäº‹ä»¶å¤„ç†å™¨ï¼‰** | å…·ä½“å¤„ç†æŸä¸ªäº‹ä»¶çš„é€»è¾‘ï¼ˆå¦‚è¯»æ•°æ®ã€å†™æ•°æ®ï¼‰ |

> ğŸ“Œ æ³¨æ„ï¼šåœ¨å®é™…å®ç°ä¸­ï¼Œ**Reactor é€šå¸¸åŒæ—¶æ‰¿æ‹… Demultiplexer + Dispatcher çš„è§’è‰²**ã€‚

#### â–¶ re_muduo ä¸­çš„å¯¹åº”å…³ç³»

| Reactor æ¨¡å¼ç»„ä»¶ | re_muduo ä¸­çš„å®ç° |
|------------------|------------------|
| **Demultiplexer** | `EpollPoller::poll()`<br>â€¢ è°ƒç”¨ `::epoll_wait()` é˜»å¡ç­‰å¾…äº‹ä»¶<br>â€¢ è¿”å›å°±ç»ªçš„ `Channel*` åˆ—è¡¨ï¼ˆé€šè¿‡ `activeChannels_`ï¼‰ |
| **Dispatcher** | `EventLoop::loop()`<br>â€¢ éå† `pollReturnTimeMs` è¿”å›çš„ `activeChannels_`<br>â€¢ å¯¹æ¯ä¸ª `Channel*` è°ƒç”¨å…¶ `handleEvent()` æ–¹æ³• |
| **EventHandler** | `Channel` åŠå…¶æ³¨å†Œçš„å›è°ƒå‡½æ•°<br>â€¢ `Channel` æœ¬èº«æ˜¯äº‹ä»¶å¥æŸ„å®¹å™¨<br>â€¢ å…·ä½“é€»è¾‘ç”±ç”¨æˆ·é€šè¿‡ `setReadCallback()` ç­‰è®¾ç½®çš„ `std::function` å®ç°ï¼ˆå¦‚ `TcpConnection::handleRead`ï¼‰ |

> âœ… **å…³é”®æµç¨‹**ï¼š
> ```cpp
> // EventLoop::loop()
> while (!quit_) {
>   activeChannels_.clear();
>   pollReturnTimeMs = poller_->poll(kPollTimeMs, &activeChannels_); // â† Demultiplexer
>   for (Channel* channel : activeChannels_) {
>     channel->handleEvent(pollReturnTimeMs); // â† Dispatcher â†’ EventHandler
>   }
>   doPendingFunctors(); // å¤„ç†è·¨çº¿ç¨‹ä»»åŠ¡
> }
> ```

> ğŸ” **ä¸ºä»€ä¹ˆ Channel æ˜¯ EventHandlerï¼Ÿ**  
> è™½ç„¶ `Channel` æœ¬èº«ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ƒæŒæœ‰æŒ‡å‘å…·ä½“å¤„ç†å‡½æ•°ï¼ˆå¦‚ `TcpConnection::handleRead`ï¼‰çš„ `std::function` å›è°ƒã€‚å› æ­¤ï¼Œ`Channel::handleEvent()` å®é™…ä¸Šæ˜¯**å›è°ƒåˆ†å‘ç‚¹**ï¼Œç¬¦åˆ EventHandler çš„â€œæ¥å£â€è§’è‰²ã€‚

---

### 2. â€œOne Loop Per Threadâ€ æ¨¡å‹åŠå…¶å®ç°æœºåˆ¶

#### â–¶ æ˜¯å¦é‡‡ç”¨ one loop per threadï¼Ÿ
**æ˜¯çš„**ã€‚`re_muduo` ä¸¥æ ¼éµå¾ª **one loop per thread** æ¨¡å‹ï¼š
- æ¯ä¸ªçº¿ç¨‹æœ€å¤šè¿è¡Œä¸€ä¸ª `EventLoop`ï¼›
- æ‰€æœ‰ I/O äº‹ä»¶ï¼ˆåŒ…æ‹¬ TCP è¯»å†™ï¼‰éƒ½åœ¨è¯¥çº¿ç¨‹çš„ `EventLoop` ä¸­ä¸²è¡Œå¤„ç†ï¼Œé¿å…é”ç«äº‰ï¼›
- æ–°è¿æ¥ç”±ä¸»çº¿ç¨‹çš„ `Acceptor` æ¥æ”¶ï¼Œç„¶å**åˆ†é…ç»™æŸä¸ªå·¥ä½œçº¿ç¨‹çš„ EventLoop** å¤„ç†ã€‚

> ğŸ’¡ è¿™æ˜¯ muduo çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š**é¿å… mutexï¼Œç”¨çº¿ç¨‹å±€éƒ¨æ€§ä¿è¯çº¿ç¨‹å®‰å…¨**ã€‚

#### â–¶ EventLoopThread ä¸ EventLoopThreadPool å¦‚ä½•åä½œï¼Ÿ

##### ï¼ˆ1ï¼‰`EventLoopThread`ï¼šå•ä¸ªçº¿ç¨‹ + å•ä¸ª EventLoop
- æ¯ä¸ª `EventLoopThread` å¯¹è±¡å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼›
- è¯¥çº¿ç¨‹æ‰§è¡Œ `threadFunc()`ï¼Œåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ª `EventLoop`ï¼›
- é€šè¿‡ `mutex_` + `condition_variable_` åŒæ­¥ï¼Œè®©å¤–éƒ¨èƒ½å®‰å…¨è·å– `EventLoop*`ï¼ˆå› ä¸º `EventLoop` å¿…é¡»åœ¨æ‰€å±çº¿ç¨‹æ„é€ ï¼‰ã€‚

```cpp
// EventLoopThread::threadFunc()
void EventLoopThread::threadFunc() {
  EventLoop loop; // åœ¨å­çº¿ç¨‹æ ˆä¸Šåˆ›å»º
  {
    std::lock_guard<std::mutex> lock(mutex_);
    loop_ = &loop;
    cond_.notify_one();
  }
  loop.loop(); // è¿›å…¥äº‹ä»¶å¾ªç¯
  loop_ = nullptr;
}
```

##### ï¼ˆ2ï¼‰`EventLoopThreadPool`ï¼šç®¡ç†å¤šä¸ª EventLoopThread
- æŒæœ‰ä¸€ä¸ª `std::vector<std::unique_ptr<EventLoopThread>> threads_`ï¼›
- å¯åŠ¨æ—¶åˆ›å»º N ä¸ª `EventLoopThread`ï¼Œæ¯ä¸ªéƒ½è¿è¡Œè‡ªå·±çš„ `EventLoop`ï¼›
- æä¾› `getNextLoop()` æ¥å£ï¼ŒæŒ‰è½®è¯¢ï¼ˆround-robinï¼‰ç­–ç•¥è¿”å›ä¸€ä¸ª `EventLoop*`ï¼›
- æ‰€æœ‰ `EventLoop*` å­˜å‚¨åœ¨ `loops_` ä¸­ï¼Œä¾› `TcpServer` åˆ†é…æ–°è¿æ¥ã€‚

```cpp
// TcpServer::newConnection()
EventLoop* ioLoop = threadPool_->getNextLoop();
// å°†æ–°è¿æ¥çš„ Channel æ³¨å†Œåˆ° ioLoop
ioLoop->runInLoop(
  std::bind(&TcpConnection::connectEstablished, conn)
);
```

##### ï¼ˆ3ï¼‰åä½œæµç¨‹ï¼ˆä»¥æ–°è¿æ¥ä¸ºä¾‹ï¼‰
1. ä¸»çº¿ç¨‹ï¼š`Acceptor` ç›‘å¬åˆ°æ–°è¿æ¥ï¼Œè°ƒç”¨ `newConnectionCallback_`ï¼›
2. `TcpServer` ä» `EventLoopThreadPool` è·å–ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„ `EventLoop*`ï¼›
3. é€šè¿‡ `EventLoop::runInLoop()` å°†â€œå»ºç«‹è¿æ¥â€ä»»åŠ¡**è·¨çº¿ç¨‹æäº¤**åˆ°ç›®æ ‡ `EventLoop`ï¼›
4. å·¥ä½œçº¿ç¨‹çš„ `EventLoop` åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œåˆ›å»º `TcpConnection` å¹¶æ³¨å†Œå…¶ `Channel`ï¼›
5. æ­¤åï¼Œè¯¥è¿æ¥çš„æ‰€æœ‰ I/O äº‹ä»¶éƒ½åœ¨è¯¥å·¥ä½œçº¿ç¨‹ä¸­å¤„ç†ã€‚

> âœ… **ä¼˜åŠ¿**ï¼š
> - **æ— é” I/O**ï¼šæ¯ä¸ªè¿æ¥çš„è¯»å†™éƒ½åœ¨å›ºå®šçº¿ç¨‹å®Œæˆï¼Œæ— éœ€åŠ é”ï¼›
> - **è´Ÿè½½å‡è¡¡**ï¼šè¿æ¥å‡åŒ€åˆ†é…åˆ°å¤šä¸ªçº¿ç¨‹ï¼›
> - **æ‰©å±•æ€§å¥½**ï¼šå¯é€šè¿‡è°ƒæ•´çº¿ç¨‹æ± å¤§å°é€‚é… CPU æ ¸å¿ƒæ•°ã€‚

---

### æ€»ç»“å›ç­”ï¼ˆé¢è¯•å£è¯­åŒ–ç²¾ç®€ç‰ˆï¼‰

> â€œReactor æ¨¡å¼æ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆReactorï¼‰ç›‘å¬å¤šä¸ª I/O äº‹ä»¶ï¼Œå¹¶åˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å™¨ã€‚åœ¨ re_muduo ä¸­ï¼Œ`EpollPoller::poll()` å……å½“ Demultiplexerï¼Œè°ƒç”¨ `epoll_wait` è·å–å°±ç»ªäº‹ä»¶ï¼›`EventLoop::loop()` æ˜¯ Dispatcherï¼Œéå†å°±ç»ªçš„ `Channel` å¹¶è°ƒç”¨å…¶ `handleEvent()`ï¼›è€Œ `Channel` æœ¬èº«ç»“åˆç”¨æˆ·æ³¨å†Œçš„å›è°ƒï¼ˆå¦‚ `TcpConnection::handleRead`ï¼‰æ„æˆäº† EventHandlerã€‚
>
> é¡¹ç›®ç¡®å®é‡‡ç”¨äº† â€˜one loop per threadâ€™ æ¨¡å‹ã€‚`EventLoopThread` å°è£…äº†ä¸€ä¸ªçº¿ç¨‹å’Œå®ƒä¸“å±çš„ `EventLoop`ï¼Œè€Œ `EventLoopThreadPool` ç®¡ç†å¤šä¸ªè¿™æ ·çš„çº¿ç¨‹ã€‚å½“æ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œ`TcpServer` ä»çº¿ç¨‹æ± ä¸­è½®è¯¢é€‰æ‹©ä¸€ä¸ª `EventLoop`ï¼Œå¹¶é€šè¿‡ `runInLoop()` å°†è¿æ¥çš„åˆå§‹åŒ–ä»»åŠ¡æäº¤åˆ°è¯¥çº¿ç¨‹ã€‚æ­¤åï¼Œè¯¥è¿æ¥çš„æ‰€æœ‰ I/O éƒ½åœ¨è¯¥çº¿ç¨‹ä¸²è¡Œå¤„ç†ï¼Œé¿å…äº†é”ç«äº‰ï¼Œæå‡äº†æ€§èƒ½ã€‚â€

